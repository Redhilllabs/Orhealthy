<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrHealthy Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; padding: 24px; display: flex; align-items: center; gap: 16px; border-radius: 12px 12px 0 0; }
        .header img { width: 48px; height: 48px; border-radius: 24px; }
        .header h1 { font-size: 28px; font-weight: 700; }
        .tabs { display: flex; border-bottom: 2px solid #eee; background: #fafafa; }
        .tab { padding: 16px 24px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; font-weight: 500; }
        .tab:hover { background: #f0f0f0; }
        .tab.active { border-bottom-color: #ffd700; background: white; color: #ffd700; }
        .content { padding: 24px; }
        .section { display: none; }
        .section.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #ffd700; }
        textarea { min-height: 100px; resize: vertical; }
        .btn { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-secondary { background: #64748b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; padding: 24px; border-radius: 12px; }
        .stat-number { font-size: 42px; font-weight: 800; margin-bottom: 8px; }
        .stat-label { font-size: 14px; opacity: 0.8; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .table th { background: #f9f9f9; font-weight: 600; }
        .table tr:hover { background: #f9f9f9; }
        .actions { display: flex; gap: 8px; }
        .actions button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 32px; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 24px; font-weight: 700; }
        .close { font-size: 32px; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .ingredient-list { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px; }
        .ingredient-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #f0f0f0; border-radius: 8px; }
        .ingredient-item input { width: 70px; padding: 6px; }
        .ingredient-item button { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://customer-assets.emergentagent.com/job_nutritionhub-1/artifacts/kq74ajf1_Orhealthy%20Favicon.png" alt="OrHealthy Logo">
            <div>
                <h1>OrHealthy Admin Panel</h1>
                <p>Manage your nutrition ecosystem</p>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('ingredients')">Ingredients</div>
            <div class="tab" onclick="switchTab('meals')">Preset Meals</div>
            <div class="tab" onclick="switchTab('users')">Users</div>
            <div class="tab" onclick="switchTab('orders')">Orders</div>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <h2 style="margin-bottom: 24px;">Dashboard</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalIngredients">0</div>
                        <div class="stat-label">Ingredients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMeals">0</div>
                        <div class="stat-label">Preset Meals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                </div>
            </div>

            <!-- Ingredients -->
            <div id="ingredients" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Ingredients Management</h2>
                    <button class="btn" onclick="showIngredientModal()">+ Add Ingredient</button>
                </div>
                <div id="alert-ingredients"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price/Unit</th>
                            <th>Unit</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ingredientsBody"></tbody>
                </table>
            </div>

            <!-- Meals -->
            <div id="meals" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Preset Meals Management</h2>
                    <button class="btn" onclick="showMealModal()">+ Add Meal</button>
                </div>
                <div id="alert-meals"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Base Price</th>
                            <th>Ingredients</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mealsBody"></tbody>
                </table>
            </div>

            <!-- Users -->
            <div id="users" class="section">
                <h2 style="margin-bottom: 20px;">Users Management</h2>
                <div id="alert-users"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Points</th>
                            <th>Inherent Points</th>
                            <th>Star Rating</th>
                            <th>Is Guide</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody"></tbody>
                </table>
            </div>

            <!-- Orders -->
            <div id="orders" class="section">
                <h2 style="margin-bottom: 20px;">Orders Management</h2>
                <div id="alert-orders"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Total Price</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Items</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="ingredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Ingredient</h2>
                <span class="close" onclick="closeModal('ingredientModal')">&times;</span>
            </div>
            <form id="ingredientForm" onsubmit="saveIngredient(event)">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="ingredientName" required>
                </div>
                <div class="form-group">
                    <label>Price per Unit *</label>
                    <input type="number" step="0.01" id="ingredientPrice" required>
                </div>
                <div class="form-group">
                    <label>Unit *</label>
                    <select id="ingredientUnit" required>
                        <option value="">Select unit</option>
                        <option value="cup">Cup</option>
                        <option value="piece">Piece</option>
                        <option value="oz">Ounce</option>
                        <option value="g">Grams</option>
                        <option value="ml">Milliliters</option>
                        <option value="bowl">Bowl</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="ingredientDescription"></textarea>
                </div>
                <button type="submit" class="btn">Save Ingredient</button>
            </form>
        </div>
    </div>

    <div id="mealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Preset Meal</h2>
                <span class="close" onclick="closeModal('mealModal')">&times;</span>
            </div>
            <form id="mealForm" onsubmit="saveMeal(event)">
                <div class="form-group">
                    <label>Meal Name *</label>
                    <input type="text" id="mealName" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="mealDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>Base Price *</label>
                    <input type="number" step="0.01" id="mealPrice" required>
                </div>
                <div class="form-group">
                    <label>Ingredients *</label>
                    <select id="mealIngredientSelect">
                        <option value="">-- Select ingredient --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="addIngredientToMeal()">Add Ingredient</button>
                    <div class="ingredient-list" id="mealIngredients"></div>
                </div>
                <button type="submit" class="btn">Save Meal</button>
            </form>
        </div>
    </div>

    <div id="userPointsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Update User Points</h2>
                <span class="close" onclick="closeModal('userPointsModal')">&times;</span>
            </div>
            <form id="userPointsForm" onsubmit="saveUserPoints(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>User Name</label>
                    <input type="text" id="userName" readonly>
                </div>
                <div class="form-group">
                    <label>Current Points</label>
                    <input type="number" id="currentPoints" readonly>
                </div>
                <div class="form-group">
                    <label>Inherent Points</label>
                    <input type="number" id="inherentPoints" value="0">
                </div>
                <button type="submit" class="btn">Update Points</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let selectedMealIngredients = [];
        let allIngredients = [];

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            switch(tabName) {
                case 'dashboard': loadDashboard(); break;
                case 'ingredients': loadIngredients(); break;
                case 'meals': loadMeals(); break;
                case 'users': loadUsers(); break;
                case 'orders': loadOrders(); break;
            }
        }

        async function loadDashboard() {
            try {
                const [users, ingredients, meals, orders] = await Promise.all([
                    fetch(`${API_URL}/admin/users`).then(r => r.json()),
                    fetch(`${API_URL}/ingredients`).then(r => r.json()),
                    fetch(`${API_URL}/meals`).then(r => r.json()),
                    fetch(`${API_URL}/admin/orders`).then(r => r.json())
                ]);
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalIngredients').textContent = ingredients.length;
                document.getElementById('totalMeals').textContent = meals.length;
                document.getElementById('totalOrders').textContent = orders.length;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadIngredients() {
            try {
                const ingredients = await fetch(`${API_URL}/ingredients`).then(r => r.json());
                allIngredients = ingredients;
                const tbody = document.getElementById('ingredientsBody');
                tbody.innerHTML = ingredients.map(ing => `
                    <tr>
                        <td>${ing.name}</td>
                        <td>$${ing.price_per_unit.toFixed(2)}</td>
                        <td>${ing.unit}</td>
                        <td>${ing.description || '-'}</td>
                        <td class="actions">
                            <button class="btn btn-danger" onclick="deleteIngredient('${ing._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
                updateMealIngredientSelect();
            } catch (error) {
                showAlert('ingredients', 'Error loading ingredients', 'error');
            }
        }

        function showIngredientModal() {
            document.getElementById('ingredientModal').classList.add('active');
            document.getElementById('ingredientForm').reset();
        }

        async function saveIngredient(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('ingredientName').value,
                price_per_unit: parseFloat(document.getElementById('ingredientPrice').value),
                unit: document.getElementById('ingredientUnit').value,
                description: document.getElementById('ingredientDescription').value
            };
            try {
                const response = await fetch(`${API_URL}/admin/ingredients`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    closeModal('ingredientModal');
                    showAlert('ingredients', 'Ingredient saved successfully', 'success');
                    loadIngredients();
                }
            } catch (error) {
                showAlert('ingredients', 'Error saving ingredient', 'error');
            }
        }

        async function deleteIngredient(id) {
            if (!confirm('Delete this ingredient?')) return;
            try {
                await fetch(`${API_URL}/admin/ingredients/${id}`, { method: 'DELETE' });
                showAlert('ingredients', 'Deleted successfully', 'success');
                loadIngredients();
            } catch (error) {
                showAlert('ingredients', 'Error deleting', 'error');
            }
        }

        async function loadMeals() {
            try {
                const meals = await fetch(`${API_URL}/meals`).then(r => r.json());
                const tbody = document.getElementById('mealsBody');
                tbody.innerHTML = meals.map(meal => `
                    <tr>
                        <td>${meal.name}</td>
                        <td>${meal.description}</td>
                        <td>$${meal.base_price.toFixed(2)}</td>
                        <td>${meal.ingredients.length} ingredients</td>
                        <td class="actions">
                            <button class="btn btn-danger" onclick="deleteMeal('${meal._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('meals', 'Error loading meals', 'error');
            }
        }

        function showMealModal() {
            document.getElementById('mealModal').classList.add('active');
            document.getElementById('mealForm').reset();
            selectedMealIngredients = [];
            document.getElementById('mealIngredients').innerHTML = '';
        }

        function updateMealIngredientSelect() {
            const select = document.getElementById('mealIngredientSelect');
            select.innerHTML = '<option value="">-- Select ingredient --</option>' +
                allIngredients.map(ing => `<option value="${ing._id}">${ing.name} ($${ing.price_per_unit}/${ing.unit})</option>`).join('');
        }

        function addIngredientToMeal() {
            const select = document.getElementById('mealIngredientSelect');
            const ingredientId = select.value;
            if (!ingredientId) return alert('Please select an ingredient');
            const ingredient = allIngredients.find(i => i._id === ingredientId);
            if (!ingredient) return;
            if (selectedMealIngredients.find(i => i.ingredient_id === ingredientId)) {
                return alert('Ingredient already added');
            }
            selectedMealIngredients.push({
                ingredient_id: ingredientId,
                name: ingredient.name,
                price: ingredient.price_per_unit,
                default_quantity: 1
            });
            renderMealIngredients();
        }

        function renderMealIngredients() {
            document.getElementById('mealIngredients').innerHTML = selectedMealIngredients.map((ing, idx) => `
                <div class="ingredient-item">
                    <span>${ing.name}</span>
                    <input type="number" min="0.1" step="0.1" value="${ing.default_quantity}" 
                           onchange="updateIngredientQuantity(${idx}, this.value)">
                    <button type="button" onclick="removeIngredientFromMeal(${idx})">×</button>
                </div>
            `).join('');
        }

        function updateIngredientQuantity(index, quantity) {
            selectedMealIngredients[index].default_quantity = parseFloat(quantity);
        }

        function removeIngredientFromMeal(index) {
            selectedMealIngredients.splice(index, 1);
            renderMealIngredients();
        }

        async function saveMeal(e) {
            e.preventDefault();
            if (selectedMealIngredients.length === 0) return alert('Add at least one ingredient');
            const data = {
                name: document.getElementById('mealName').value,
                description: document.getElementById('mealDescription').value,
                base_price: parseFloat(document.getElementById('mealPrice').value),
                ingredients: selectedMealIngredients,
                is_preset: true,
                created_by: 'admin'
            };
            try {
                const response = await fetch(`${API_URL}/admin/meals`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    closeModal('mealModal');
                    showAlert('meals', 'Meal saved successfully', 'success');
                    loadMeals();
                }
            } catch (error) {
                showAlert('meals', 'Error saving meal', 'error');
            }
        }

        async function deleteMeal(id) {
            if (!confirm('Delete this meal?')) return;
            try {
                await fetch(`${API_URL}/admin/meals/${id}`, { method: 'DELETE' });
                showAlert('meals', 'Deleted successfully', 'success');
                loadMeals();
            } catch (error) {
                showAlert('meals', 'Error deleting', 'error');
            }
        }

        async function loadUsers() {
            try {
                const users = await fetch(`${API_URL}/admin/users`).then(r => r.json());
                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.points}</td>
                        <td>${user.inherent_points}</td>
                        <td>${user.star_rating} ⭐</td>
                        <td>${user.is_guide ? 'Yes' : 'No'}</td>
                        <td class="actions">
                            <button class="btn" onclick="showUserPointsModal('${user._id}', '${user.name}', ${user.points}, ${user.inherent_points})">
                                Update Points
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('users', 'Error loading users', 'error');
            }
        }

        function showUserPointsModal(id, name, points, inherentPoints) {
            document.getElementById('userPointsModal').classList.add('active');
            document.getElementById('userId').value = id;
            document.getElementById('userName').value = name;
            document.getElementById('currentPoints').value = points;
            document.getElementById('inherentPoints').value = inherentPoints;
        }

        async function saveUserPoints(e) {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const inherentPoints = parseInt(document.getElementById('inherentPoints').value);
            try {
                const response = await fetch(`${API_URL}/admin/users/${userId}/points`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ inherent_points: inherentPoints })
                });
                if (response.ok) {
                    closeModal('userPointsModal');
                    showAlert('users', 'Points updated successfully', 'success');
                    loadUsers();
                }
            } catch (error) {
                showAlert('users', 'Error updating points', 'error');
            }
        }

        async function loadOrders() {
            try {
                const orders = await fetch(`${API_URL}/admin/orders`).then(r => r.json());
                const tbody = document.getElementById('ordersBody');
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>${order._id.substring(0, 8)}...</td>
                        <td>$${order.total_price.toFixed(2)}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order._id}', this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>${order.items.length} items</td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('orders', 'Error loading orders', 'error');
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                await fetch(`${API_URL}/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status })
                });
                showAlert('orders', 'Order status updated', 'success');
            } catch (error) {
                showAlert('orders', 'Error updating order', 'error');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(section, message, type) {
            const alertDiv = document.getElementById(`alert-${section}`);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 3000);
        }

        // Initialize
        loadDashboard();
        loadIngredients();
    </script>
</body>
</html>
