<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrHealthy Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 12px rgba(0,0,0,0.2); position: fixed; height: 100vh; left: 0; top: 0; }
        .logo-section { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; background: rgba(255,215,0,0.1); }
        .logo-section img { width: 48px; height: 48px; border-radius: 12px; }
        .logo-text h1 { font-size: 20px; font-weight: 700; color: #ffd700; }
        .logo-text p { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        .nav-menu { flex: 1; padding: 16px 0; overflow-y: auto; }
        .nav-item { padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; color: rgba(255,255,255,0.7); border-left: 3px solid transparent; font-size: 14px; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: rgba(255,215,0,0.15); color: #ffd700; border-left-color: #ffd700; }
        .nav-icon { font-size: 18px; width: 20px; }
        
        /* Main Content */
        .main-content { flex: 1; margin-left: 260px; }
        .top-bar { background: white; padding: 20px 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 700; color: #1e293b; }
        .content-area { padding: 32px; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(255,215,0,0.2); }
        .stat-number { font-size: 40px; font-weight: 800; margin-bottom: 8px; }
        .stat-label { font-size: 13px; opacity: 0.8; font-weight: 600; }
        
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 20px; font-weight: 700; color: #1e293b; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, textarea, select { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #ffd700; box-shadow: 0 0 0 3px rgba(255,215,0,0.1); }
        textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        
        .btn { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #1e293b; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255,215,0,0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,215,0,0.4); }
        .btn-secondary { background: #64748b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .image-upload { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc; }
        .image-upload:hover { border-color: #ffd700; background: rgba(255,215,0,0.05); }
        .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 12px; }
        .image-preview-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-remove { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; font-weight: bold; }
        
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 14px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .table th { background: #f8fafc; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        .table tr:hover { background: #f8fafc; }
        .table-image { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
        
        .actions { display: flex; gap: 8px; }
        .actions button { padding: 6px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 32px; border-radius: 16px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f1f5f9; }
        .modal-title { font-size: 22px; font-weight: 700; color: #1e293b; }
        .close { font-size: 28px; cursor: pointer; color: #94a3b8; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s; }
        .close:hover { background: #f1f5f9; color: #475569; }
        
        .alert { padding: 14px 18px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        
        .ingredient-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .ingredient-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #f1f5f9; border-radius: 8px; font-size: 13px; }
        .ingredient-item input { width: 60px; padding: 4px 8px; font-size: 13px; }
        .ingredient-item button { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 4px 10px; cursor: pointer; font-weight: 600; }
        
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px; }
        .config-label { font-weight: 600; color: #475569; }
        .config-input { width: 120px; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; }
        
        .purchase-history-row { background: #f8fafc; }
        .purchase-history { padding: 20px; }
        .purchase-history h4 { margin: 0 0 16px 0; color: #334155; font-size: 16px; }
        .purchase-history table { margin-top: 0; }
        
        .submenu { padding-left: 20px; }
        .submenu-item { padding-left: 30px !important; font-size: 14px; }
        .submenu-item .nav-icon { font-size: 16px; }
        
        .status-tab { background: #f1f5f9; border: none; padding: 10px 16px; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600; color: #64748b; transition: all 0.2s; }
        .status-tab:hover { background: #e2e8f0; }
        .status-tab.active { background: #ffd700; color: #1e293b; }
        
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .status-arrived { background: #dbeafe; color: #1e40af; }
        .status-accepted { background: #e0e7ff; color: #4338ca; }
        .status-preparing { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-out_for_delivery { background: #fce7f3; color: #9f1239; }
        .status-delivered { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-section">
            <img src="https://customer-assets.emergentagent.com/job_nutritionhub-1/artifacts/kq74ajf1_Orhealthy%20Favicon.png" alt="Logo">
            <div class="logo-text">
                <h1>OrHealthy</h1>
                <p>Admin Panel</p>
            </div>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" data-tab="dashboard">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-tab="products-toggle">
                <span class="nav-icon">üì¶</span>
                <span>Products</span>
                <span style="margin-left: auto;">‚ñº</span>
            </div>
            <div id="productsSubmenu" class="submenu" style="display: none;">
                <div class="nav-item submenu-item" data-tab="source-ingredients">
                    <span class="nav-icon">üåæ</span>
                    <span>Source Ingredients</span>
                </div>
                <div class="nav-item submenu-item" data-tab="ingredients">
                    <span class="nav-icon">ü•ó</span>
                    <span>Processed Ingredients</span>
                </div>
                <div class="nav-item submenu-item" data-tab="meals">
                    <span class="nav-icon">üìñ</span>
                    <span>Meals</span>
                </div>
                <div class="nav-item submenu-item" data-tab="combos">
                    <span class="nav-icon">üçΩÔ∏è</span>
                    <span>Combos</span>
                </div>
            </div>
            <div class="nav-item" data-tab="users">
                <span class="nav-icon">üë•</span>
                <span>Users</span>
            </div>
            <div class="nav-item" data-tab="orders">
                <span class="nav-icon">üì¶</span>
                <span>Orders</span>
            </div>
            <div class="nav-item" data-tab="delivery">
                <span class="nav-icon">üöö</span>
                <span>Delivery</span>
            </div>
            <div class="nav-item" data-tab="coupons">
                <span class="nav-icon">üéüÔ∏è</span>
                <span>Coupons</span>
            </div>
            <div class="nav-item" data-tab="withdrawals">
                <span class="nav-icon">üí∞</span>
                <span>Withdrawals</span>
            </div>
            <div class="nav-item" data-tab="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
        </div>
        
        <div class="content-area">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalIngredients">0</div>
                        <div class="stat-label">Ingredients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMeals">0</div>
                        <div class="stat-label">Preset Meals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                </div>
            </div>

            <!-- Source Ingredients -->
            <div id="source-ingredients" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Source Ingredients Management</h2>
                        <button class="btn" onclick="showSourceIngredientModal()">+ Add Source Ingredient</button>
                    </div>
                    <div id="alert-source-ingredients"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Unit</th>
                                <th>Latest Purchase</th>
                                <th>SUP (Latest)</th>
                                <th>SUP (Lowest)</th>
                                <th>SUP (Highest)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sourceIngredientsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Ingredients -->
            <div id="ingredients" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Ingredients Management</h2>
                        <button class="btn" onclick="showIngredientModal()">+ Add Ingredient</button>
                    </div>
                    <div id="alert-ingredients"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Price/Unit</th>
                                <th>Unit</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Recipes -->
            <div id="meals" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recipe Management</h2>
                        <button class="btn" onclick="showMealModal()">+ Add Recipe</button>
                    </div>
                    <div id="alert-recipes"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mealsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Meals (Combinations of Recipes) -->
            <div id="combos" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Meals Management</h2>
                        <button class="btn" onclick="showComboModal()">+ Add Meal</button>
                    </div>
                    <div id="alert-meals"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Recipes</th>
                                <th>Price (Calculated)</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="combosBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Duplicate recipes section removed -->

            <!-- Users -->
            <div id="users" class="section">
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 20px;">Users Management</h2>
                    <div id="alert-users"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Points</th>
                                <th>Inherent</th>
                                <th>Stars</th>
                                <th>Is Guide</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Delivery -->
            <div id="delivery" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Delivery Agents Management</h2>
                        <button class="btn" onclick="showDeliveryAgentModal()">+ Add Delivery Agent</button>
                    </div>
                    <div id="alert-delivery"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Vehicle</th>
                                <th>Payment/Delivery</th>
                                <th>Wallet Balance</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deliveryAgentsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Orders -->
            <div id="orders" class="section">
                <div class="card">
                    <div id="alert-orders"></div>
                    
                    <!-- Status Tabs -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap;">
                        <button class="status-tab active" data-status="all">All</button>
                        <button class="status-tab" data-status="arrived">Arrived</button>
                        <button class="status-tab" data-status="accepted">Accepted</button>
                        <button class="status-tab" data-status="preparing">Preparing</button>
                        <button class="status-tab" data-status="ready">Ready</button>
                        <button class="status-tab" data-status="out_for_delivery">Out for Delivery</button>
                        <button class="status-tab" data-status="delivered">Delivered</button>
                        <button class="status-tab" data-status="cancelled">Cancelled</button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>User</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Agent</th>
                                <th>Date</th>
                                <th>Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings -->

            <!-- Coupons -->
            <div id="coupons" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Discount Coupons</h2>
                        <button class="btn" onclick="showAddCouponModal()">+ Add Coupon</button>
                    </div>
                    <div id="alert-coupons"></div>
                    <table class="table" id="couponsTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Min Order</th>
                                <th>Usage</th>
                                <th>Expiry</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="couponsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Withdrawals -->
            <div id="withdrawals" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Withdrawal Requests</h2>
                    </div>
                    <div id="alert-withdrawals"></div>
                    <table class="table" id="withdrawalsTable">
                        <thead>
                            <tr>
                                <th>Guide</th>
                                <th>Amount</th>
                                <th>Requested On</th>
                                <th>Status</th>
                                <th>Processed On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTableBody"></tbody>
                    </table>
                </div>
            </div>


            <div id="settings" class="section">
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 20px;">Star Rating Configuration</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Configure the points required for each star rating level. Users with 1+ stars become Guides.</p>
                    <div id="alert-settings"></div>
                    
                    <div id="starRatingsList"></div>
                    
                    <button class="btn btn-secondary" style="margin-top: 16px; margin-right: 12px;" onclick="addStarRating()">+ Add Rating Level</button>
                    <button class="btn" style="margin-top: 16px;" onclick="saveStarConfig()">Save Configuration</button>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h2 class="card-title" style="margin-bottom: 20px;">Points Configuration</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Configure points earned for different actions.</p>
                    <div id="alert-points"></div>
                    
                    <div style="display: grid; gap: 16px;">
                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">üìù Per Post</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerPost" value="5" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>

                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">‚ù§Ô∏è Per Like Received</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerLike" value="2" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>

                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">üë• Per New Fan</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerFan" value="3" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>

                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">üéì Per New Guidee</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerGuidee" value="5" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>
                    </div>
                    
                    <button class="btn" style="margin-top: 24px;" onclick="savePointsConfig()">Save Points Configuration</button>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h2 class="card-title" style="margin-bottom: 20px;">üîê Admin Credentials</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Change your admin email and password.</p>
                    <div id="alert-credentials"></div>
                    
                    <form id="credentialsForm" onsubmit="changeAdminCredentials(event)">
                        <div class="form-group">
                            <label>Current Password *</label>
                            <input type="password" id="currentPassword" required placeholder="Enter current password">
                        </div>
                        
                        <div class="form-group">
                            <label>New Email (optional)</label>
                            <input type="email" id="newEmail" placeholder="Leave blank to keep current">
                        </div>
                        
                        <div class="form-group">
                            <label>New Password (optional)</label>
                            <input type="password" id="newPassword" placeholder="Leave blank to keep current">
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password">
                        </div>
                        
                        <button type="submit" class="btn">Update Credentials</button>
                        <button type="button" class="btn btn-danger" style="margin-left: 12px;" onclick="adminLogout()">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Source Ingredient Modal -->
    <div id="sourceIngredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Source Ingredient</h2>
                <span class="close" onclick="closeModal('sourceIngredientModal')">&times;</span>
            </div>
            <form id="sourceIngredientForm" onsubmit="saveSourceIngredient(event)">
                <div class="form-group">
                    <label>Image</label>
                    <div class="image-upload" onclick="document.getElementById('sourceImage').click()">
                        <div style="font-size: 40px; margin-bottom: 8px;">üì∑</div>
                        <div style="font-weight: 600; color: #475569;">Click to upload image</div>
                    </div>
                    <input type="file" id="sourceImage" accept="image/*" style="display: none;" onchange="handleSourceImage(event)">
                    <div id="sourceImagePreview" style="margin-top: 12px;"></div>
                </div>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="sourceName" required placeholder="e.g., Kala Chana">
                </div>
                <div class="form-group">
                    <label>Unit *</label>
                    <select id="sourceUnit" required>
                        <option value="">Select unit</option>
                        <option value="pcs">Pieces (pcs)</option>
                        <option value="kg">Kilograms (kg)</option>
                        <option value="g">Grams (g)</option>
                        <option value="liters">Liters</option>
                        <option value="ml">Milliliters (ml)</option>
                        <option value="dozen">Dozen</option>
                    </select>
                </div>
                <button type="submit" class="btn">Create Source Ingredient</button>
            </form>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Purchase</h2>
                <span class="close" onclick="closeModal('purchaseModal')">&times;</span>
            </div>
            <form id="purchaseForm" onsubmit="savePurchase(event)">
                <div class="form-group">
                    <label>Purchase Quantity *</label>
                    <input type="number" step="0.01" id="purchaseQuantity" required placeholder="e.g., 8">
                    <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                        The quantity of the source ingredient purchased
                    </small>
                </div>
                <div class="form-group">
                    <label>Purchase Price (‚Çπ) *</label>
                    <input type="number" step="0.01" id="purchasePrice" required placeholder="e.g., 100">
                    <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                        Total price paid for this purchase
                    </small>
                </div>
                <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 13px; color: #475569;">
                        <strong>Note:</strong> Unit price will be calculated automatically as (Purchase Price √∑ Purchase Quantity)
                    </p>
                </div>
                <button type="submit" class="btn">Add Purchase</button>
            </form>
        </div>
    </div>

    <!-- Delivery Agent Modal -->
    <div id="deliveryAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Delivery Agent</h2>
                <span class="close" onclick="closeModal('deliveryAgentModal')">&times;</span>
            </div>
            <form id="deliveryAgentForm" onsubmit="saveDeliveryAgent(event)">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="agentName" required placeholder="Full name">
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="agentEmail" required placeholder="agent@example.com">
                </div>
                <div class="form-group">
                    <label>Contact Number *</label>
                    <input type="tel" id="agentContactNumber" required placeholder="e.g., +91 98765 43210">
                </div>
                <div class="form-group">
                    <label>Vehicle *</label>
                    <select id="agentVehicle" required>
                        <option value="">Select vehicle</option>
                        <option value="bike">Bike</option>
                        <option value="scooter">Scooter</option>
                        <option value="car">Car</option>
                        <option value="van">Van</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vehicle Number *</label>
                    <input type="text" id="agentVehicleNumber" required placeholder="e.g., MH 02 AB 1234">
                </div>
                <div class="form-group">
                    <label>Payment Per Delivery (‚Çπ) *</label>
                    <input type="number" id="agentPaymentPerDelivery" required placeholder="e.g., 50" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Image</label>
                    <div class="image-upload" onclick="document.getElementById('agentImage').click()">
                        <div style="font-size: 40px; margin-bottom: 8px;">üì∑</div>
                        <div style="font-weight: 600; color: #475569;">Click to upload image</div>
                    </div>
                    <input type="file" id="agentImage" accept="image/*" style="display: none;" onchange="handleAgentImage(event)">
                    <div id="agentImagePreview" style="margin-top: 12px;"></div>
                </div>
                <button type="submit" class="btn">Create Delivery Agent</button>
            </form>
        </div>
    </div>

    <!-- Assign Agent Modal -->
    <div id="assignAgentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign Delivery Agent</h2>
                <span class="close" onclick="closeModal('assignAgentModal')">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 16px; color: #64748b;">Select an available agent for this order:</p>
                <div id="availableAgentsList"></div>
                <div id="selectedAgentInfo" style="display: none; background: #f0f9ff; border: 2px solid #3b82f6; padding: 16px; border-radius: 8px; margin-top: 16px;">
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Selected Agent:</div>
                    <div id="selectedAgentDetails"></div>
                </div>
                <div id="assignAgentError" style="color: #ef4444; margin-top: 16px; display: none;"></div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button id="confirmAssignBtn" class="btn" style="flex: 1; display: none;" onclick="confirmAssignAgent()">
                        Assign & Move to Out for Delivery
                    </button>
                    <button class="btn" style="flex: 1; background: #6b7280;" onclick="closeModal('assignAgentModal')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="ingredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Ingredient</h2>
                <span class="close" onclick="closeModal('ingredientModal')">&times;</span>
            </div>
            <form id="ingredientForm" onsubmit="saveIngredient(event)">
                <div class="form-group">
                    <label>Images</label>
                    <div class="image-upload" onclick="document.getElementById('ingredientImages').click()">
                        <div style="font-size: 40px; margin-bottom: 8px;">üì∑</div>
                        <div style="font-weight: 600; color: #475569;">Click to upload images</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Multiple images supported</div>
                    </div>
                    <input type="file" id="ingredientImages" multiple accept="image/*" style="display: none;" onchange="handleIngredientImages(event)">
                    <div id="ingredientImagePreview" class="image-preview-grid"></div>
                </div>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="ingredientName" required>
                </div>
                
                <!-- Source Ingredient Section -->
                <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #334155; font-size: 14px;">üåæ Source Ingredients Linking (Optional)</h4>
                        <button type="button" class="btn" style="padding: 6px 12px; font-size: 13px;" onclick="addSourceIngredientEntry()">+ Add Source</button>
                    </div>
                    <div id="sourceIngredientsContainer"></div>
                    <small style="color: #64748b; font-size: 12px; margin-top: 8px; display: block;">
                        Add one or more source ingredients. Total price will be sum of (source quantity √ó unit price) for all sources.
                    </small>
                </div>
                
                <!-- Margin Fields Section -->
                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin: 0 0 16px 0; color: #92400e; font-size: 14px;">üí∞ Additional Margins (‚Çπ)</h4>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label style="font-size: 12px;">Product Margin</label>
                        <input type="number" step="0.01" id="productMargin" value="0">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label style="font-size: 12px;">Operations Margin</label>
                        <input type="number" step="0.01" id="operationsMargin" value="0">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label style="font-size: 12px;">Branding Margin</label>
                        <input type="number" step="0.01" id="brandingMargin" value="0">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label style="font-size: 12px;">Rest Margins</label>
                        <input type="number" step="0.01" id="restMargins" value="0">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Miscellaneous Margins</label>
                        <input type="number" step="0.01" id="miscellaneousMargins" value="0">
                    </div>
                    
                    <small style="color: #92400e; font-size: 11px; margin-top: 12px; display: block;">
                        These margins will be added to the calculated price from source ingredients
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Price per Unit (‚Çπ) *</label>
                    <input type="number" step="0.01" id="ingredientPrice" required>
                    <small id="priceCalculationInfo" style="color: #0ea5e9; font-size: 12px; margin-top: 4px; display: none;"></small>
                </div>
                <div class="form-group">
                    <label>Unit *</label>
                    <select id="ingredientUnit" required>
                        <option value="">Select unit</option>
                        <option value="cup">Cup</option>
                        <option value="piece">Piece</option>
                        <option value="oz">Ounce</option>
                        <option value="g">Grams</option>
                        <option value="ml">Milliliters</option>
                        <option value="bowl">Bowl</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Step Size *</label>
                    <input type="number" step="0.01" min="0.01" id="stepSize" value="1" required>
                    <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                        Increment/decrement step for quantity adjustment in the app (e.g., 0.5 for half cup steps)
                    </small>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="ingredientTags" placeholder="e.g. protein, vegetarian, organic">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="ingredientDescription"></textarea>
                </div>
                
                <!-- Nutrition Profile Section -->
                <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: #166534; font-size: 14px;">ü•ó Nutrition Profile (per unit)</h4>
                        <button type="button" class="btn" style="padding: 6px 12px; font-size: 13px;" onclick="addNutritionEntry()">+ Add Entry</button>
                    </div>
                    <div id="nutritionProfileContainer"></div>
                </div>
                
                <button type="submit" class="btn">Save Processed Ingredient</button>
            </form>
        </div>
    </div>

    <!-- Recipe Modal (formerly Meal Modal) -->
    <div id="mealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Recipe</h2>
                <span class="close" onclick="closeModal('mealModal')">&times;</span>
            </div>
            <form id="mealForm" onsubmit="saveMeal(event)">
                <div class="form-group">
                    <label>Images</label>
                    <div class="image-upload" onclick="document.getElementById('mealImages').click()">
                        <div style="font-size: 40px; margin-bottom: 8px;">üì∑</div>
                        <div style="font-weight: 600; color: #475569;">Click to upload images</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Multiple images supported</div>
                    </div>
                    <input type="file" id="mealImages" multiple accept="image/*" style="display: none;" onchange="handleMealImages(event)">
                    <div id="mealImagePreview" class="image-preview-grid"></div>
                </div>
                <div class="form-group">
                    <label>Recipe Name *</label>
                    <input type="text" id="mealName" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="mealDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="mealTags" placeholder="e.g. high-protein, low-carb, vegan">
                </div>
                <div class="form-group">
                    <label>Categories (comma separated) *</label>
                    <input type="text" id="mealCategories" placeholder="e.g. Bowls, Salads" required>
                    <small style="color: #64748b;">Recipes with "Bowls" category will appear in Bowls tab</small>
                </div>
                <div class="form-group">
                    <label>Price (Auto-calculated from ingredients)</label>
                    <input type="number" step="0.01" id="mealPrice" readonly value="0.00">
                    <small style="color: #64748b;">Price will be calculated based on selected ingredients</small>
                </div>
                <div class="form-group">
                    <label>Ingredients *</label>
                    <select id="mealIngredientSelect">
                        <option value="">-- Select processed ingredient --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="addIngredientToMeal()">Add Ingredient</button>
                    <div class="ingredient-list" id="mealIngredients"></div>
                </div>
                <button type="submit" class="btn">Save Meal</button>
            </form>
        </div>
    </div>

    <!-- Meal Modal (NEW - for meal combinations) -->
    <div id="comboModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Meal</h2>
                <span class="close" onclick="closeModal('comboModal')">&times;</span>
            </div>
            <form id="comboForm" onsubmit="saveCombo(event)">
                <div class="form-group">
                    <label>Images</label>
                    <div class="image-upload" onclick="document.getElementById('comboImages').click()">
                        <div style="font-size: 40px; margin-bottom: 8px;">üì∑</div>
                        <div style="font-weight: 600; color: #475569;">Click to upload images</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Multiple images supported</div>
                    </div>
                    <input type="file" id="comboImages" multiple accept="image/*" style="display: none;" onchange="handleComboImages(event)">
                    <div id="comboImagePreview" class="image-preview-grid"></div>
                </div>
                <div class="form-group">
                    <label>Meal Name *</label>
                    <input type="text" id="comboName" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="comboDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="comboTags" placeholder="e.g. breakfast, lunch, dinner">
                </div>
                <div class="form-group">
                    <label>Price (Auto-calculated from recipes)</label>
                    <input type="number" step="0.01" id="comboPrice" readonly value="0.00">
                    <small style="color: #64748b;">Price will be calculated based on selected recipes</small>
                </div>
                <div class="form-group">
                    <label>Recipes *</label>
                    <select id="comboMealSelect">
                        <option value="">-- Select recipe --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="addMealToCombo()">Add Recipe</button>
                    <div class="ingredient-list" id="comboMeals"></div>
                </div>
                <button type="submit" class="btn">Save Meal</button>
            </form>
        </div>
    </div>

    <div id="userPointsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Update User Points</h2>
                <span class="close" onclick="closeModal('userPointsModal')">&times;</span>
            </div>
            <form id="userPointsForm" onsubmit="saveUserPoints(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>User Name</label>
                    <input type="text" id="userName" readonly>
                </div>
                <div class="form-group">
                    <label>Current Points</label>
                    <input type="number" id="currentPoints" readonly>
                </div>
                <div class="form-group">
                    <label>Inherent Points</label>
                    <input type="number" id="inherentPoints" value="0">
                </div>
                <button type="submit" class="btn">Update Points</button>
            </form>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="couponModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="couponModalTitle">Add Coupon</h2>
                <span class="close" onclick="closeModal('couponModal')">&times;</span>
            </div>
            <form id="couponForm" onsubmit="saveCoupon(event)">
                <div class="form-group">
                    <label>Coupon Code *</label>
                    <input type="text" id="couponCode" required style="text-transform: uppercase;" placeholder="e.g. WELCOME10">
                </div>
                <div class="form-group">
                    <label>Discount Type *</label>
                    <select id="couponDiscountType" required onchange="updateDiscountLabel()">
                        <option value="percentage">Percentage (%)</option>
                        <option value="flat">Flat Amount (‚Çπ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="discountValueLabel">Discount Percentage (%) *</label>
                    <input type="number" step="0.01" id="couponDiscountValue" required min="0">
                </div>
                <div class="form-group">
                    <label>Minimum Order Value (‚Çπ) *</label>
                    <input type="number" step="0.01" id="couponMinOrder" required min="0">
                </div>
                <div class="form-group">
                    <label>Usage Limit Type *</label>
                    <select id="couponUsageLimitType" required>
                        <option value="one_time">One Time Per User</option>
                        <option value="recurring">Recurring</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expiry Date *</label>
                    <input type="datetime-local" id="couponExpiryDate" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="couponActive" checked>
                        Active
                    </label>
                </div>
                <button type="submit" class="btn">Save Coupon</button>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Order Details</h2>
                <span class="close" onclick="closeModal('orderDetailsModal')">&times;</span>
            </div>
            <div id="orderDetailsContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>


    <script>
        const API_URL = '/api';
        let selectedMealIngredients = [];
        let allIngredients = [];
        let ingredientImages = [];
        let mealImages = [];
        let editingIngredientId = null;
        let editingMealId = null;
        let editingCouponId = null;
        
        // Combo-specific variables
        let comboImages = [];
        let selectedComboMeals = [];
        let editingComboId = null;


        const pageTitles = {
            dashboard: 'Dashboard',
            'source-ingredients': 'Source Ingredients Management',
            ingredients: 'Processed Ingredients Management',
            meals: 'Meals Management',
            combos: 'Combos Management',
            users: 'Users Management',
            delivery: 'Delivery Agents Management',
            orders: 'Orders Management',
            coupons: 'Coupons Management',
            withdrawals: 'Withdrawals Management',
            settings: 'Settings'
        };

        function toggleProductsMenu() {
            const submenu = document.getElementById('productsSubmenu');
            if (submenu.style.display === 'none') {
                submenu.style.display = 'block';
            } else {
                submenu.style.display = 'none';
            }
        }

        function switchTab(tabName) {
            console.log('switchTab called with:', tabName);
            
            // Remove active class from all nav items and sections
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            // Find and activate the clicked nav item
            const clickedItem = Array.from(document.querySelectorAll('.nav-item')).find(
                item => item.getAttribute('onclick') && item.getAttribute('onclick').includes(`switchTab('${tabName}')`)
            );
            if (clickedItem) {
                clickedItem.classList.add('active');
                console.log('Added active class to nav item');
            }
            
            // Show the selected section
            const section = document.getElementById(tabName);
            if (section) {
                section.classList.add('active');
                console.log('Activated section:', tabName);
            } else {
                console.error('Section not found:', tabName);
            }
            
            // Update page title
            const titleElement = document.getElementById('pageTitle');
            if (titleElement) {
                titleElement.textContent = pageTitles[tabName] || tabName;
            }

            // Load data for the selected tab
            console.log('Loading data for:', tabName);
            switch(tabName) {
                case 'dashboard': loadDashboard(); break;
                case 'source-ingredients': loadSourceIngredients(); break;
                case 'ingredients': loadIngredients(); break;
                case 'meals': loadMeals(); break;
                case 'combos': loadCombos(); break;
                case 'users': loadUsers(); break;
                case 'delivery': loadDeliveryAgents(); break;
                case 'orders': loadOrders(); break;
                case 'coupons': loadCoupons(); break;
                case 'withdrawals': loadWithdrawals(); break;
                case 'settings': loadSettings(); break;
            }
        }

        function handleIngredientImages(event) {
            const files = Array.from(event.target.files);
            ingredientImages = [];
            const preview = document.getElementById('ingredientImagePreview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    ingredientImages.push(e.target.result);
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeIngredientImage(${index})">√ó</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeIngredientImage(index) {
            ingredientImages.splice(index, 1);
            document.getElementById('ingredientImages').value = '';
            handleIngredientImages({ target: { files: [] } });
        }

        function handleMealImages(event) {
            const files = Array.from(event.target.files);
            mealImages = [];
            const preview = document.getElementById('mealImagePreview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mealImages.push(e.target.result);
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeMealImage(${index})">√ó</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeMealImage(index) {
            mealImages.splice(index, 1);
            document.getElementById('mealImages').value = '';
            handleMealImages({ target: { files: [] } });
        }

        async function loadDashboard() {
            try {
                const [users, ingredients, meals, orders] = await Promise.all([
                    fetch(`${API_URL}/admin/users`).then(r => r.json()),
                    fetch(`${API_URL}/ingredients`).then(r => r.json()),
                    fetch(`${API_URL}/meals`).then(r => r.json()),
                    fetch(`${API_URL}/admin/orders`).then(r => r.json())
                ]);
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalIngredients').textContent = ingredients.length;
                document.getElementById('totalMeals').textContent = meals.length;
                document.getElementById('totalOrders').textContent = orders.length;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Source Ingredients Functions
        let allSourceIngredients = [];
        let sourceIngredientImage = null;
        let editingSourceId = null;
        let expandedSourceIds = new Set();

        async function loadSourceIngredients() {
            try {
                const sources = await fetch(`${API_URL}/source-ingredients`).then(r => r.json());
                allSourceIngredients = sources;
                const tbody = document.getElementById('sourceIngredientsBody');
                tbody.innerHTML = sources.map(source => `
                    <tr>
                        <td>${source.image ? `<img src="${source.image}" class="table-image">` : '-'}</td>
                        <td>${source.name}</td>
                        <td>${source.unit}</td>
                        <td>${source.latest_purchase ? `${source.latest_purchase.purchase_quantity} ${source.unit} @ ‚Çπ${source.latest_purchase.purchase_price}` : 'No purchases'}</td>
                        <td>‚Çπ${source.latest_unit_price.toFixed(2)}</td>
                        <td>‚Çπ${source.lowest_unit_price.toFixed(2)}</td>
                        <td>‚Çπ${source.highest_unit_price.toFixed(2)}</td>
                        <td class="actions">
                            <button class="btn" style="font-size: 12px;" onclick="togglePurchaseHistory('${source._id}')">üìú History</button>
                            <button class="btn" onclick="editSourceIngredient('${source._id}')">Edit</button>
                            <button class="btn" onclick="showAddPurchaseModal('${source._id}')">+ Purchase</button>
                            <button class="btn btn-danger" onclick="deleteSourceIngredient('${source._id}')">Delete</button>
                        </td>
                    </tr>
                    <tr id="history-${source._id}" class="purchase-history-row" style="display: none;">
                        <td colspan="8">
                            <div class="purchase-history">
                                <h4>Purchase History for ${source.name}</h4>
                                ${source.purchases && source.purchases.length > 0 ? 
                                    '<table class="table"><thead><tr><th>Date</th><th>Quantity</th><th>Price</th><th>Unit Price</th><th>Actions</th></tr></thead><tbody>' +
                                    source.purchases.map((p, idx) => `
                                        <tr>
                                            <td>${new Date(p.purchase_date).toLocaleDateString()}</td>
                                            <td>${p.purchase_quantity} ${source.unit}</td>
                                            <td>‚Çπ${p.purchase_price.toFixed(2)}</td>
                                            <td>‚Çπ${p.unit_price.toFixed(2)} per ${source.unit}</td>
                                            <td><button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deletePurchase('${source._id}', ${idx})">Delete</button></td>
                                        </tr>
                                    `).join('') +
                                    '</tbody></table>'
                                    : '<p>No purchase history</p>'}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('source-ingredients', 'Error loading source ingredients', 'error');
            }
        }

        function togglePurchaseHistory(sourceId) {
            const historyRow = document.getElementById(`history-${sourceId}`);
            if (expandedSourceIds.has(sourceId)) {
                historyRow.style.display = 'none';
                expandedSourceIds.delete(sourceId);
            } else {
                historyRow.style.display = 'table-row';
                expandedSourceIds.add(sourceId);
            }
        }

        function showSourceIngredientModal() {
            editingSourceId = null;
            document.getElementById('sourceIngredientModal').classList.add('active');
            document.querySelector('#sourceIngredientModal .modal-title').textContent = 'Add Source Ingredient';
            document.getElementById('sourceIngredientForm').reset();
            sourceIngredientImage = null;
            document.getElementById('sourceImagePreview').innerHTML = '';
        }

        async function editSourceIngredient(sourceId) {
            editingSourceId = sourceId;
            try {
                const source = allSourceIngredients.find(s => s._id === sourceId);
                if (!source) return;
                
                document.getElementById('sourceIngredientModal').classList.add('active');
                document.querySelector('#sourceIngredientModal .modal-title').textContent = 'Edit Source Ingredient';
                document.getElementById('sourceName').value = source.name;
                document.getElementById('sourceUnit').value = source.unit;
                
                // Set existing image
                sourceIngredientImage = source.image || null;
                if (source.image) {
                    document.getElementById('sourceImagePreview').innerHTML = `
                        <img src="${source.image}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                    `;
                } else {
                    document.getElementById('sourceImagePreview').innerHTML = '';
                }
            } catch (error) {
                showAlert('source-ingredients', 'Error loading source ingredient data', 'error');
            }
        }

        function handleSourceImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    sourceIngredientImage = e.target.result;
                    document.getElementById('sourceImagePreview').innerHTML = `
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveSourceIngredient(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('sourceName').value,
                unit: document.getElementById('sourceUnit').value,
                image: sourceIngredientImage
            };
            
            try {
                let response;
                if (editingSourceId) {
                    // Update existing source ingredient
                    response = await fetch(`${API_URL}/source-ingredients/${editingSourceId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new source ingredient
                    response = await fetch(`${API_URL}/source-ingredients`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeModal('sourceIngredientModal');
                    showAlert('source-ingredients', editingSourceId ? 'Source ingredient updated successfully' : 'Source ingredient created successfully', 'success');
                    loadSourceIngredients();
                } else {
                    const error = await response.json();
                    showAlert('source-ingredients', error.detail || 'Error saving source ingredient', 'error');
                }
            } catch (error) {
                showAlert('source-ingredients', 'Error saving source ingredient', 'error');
            }
        }

        function showAddPurchaseModal(sourceId) {
            editingSourceId = sourceId;
            const source = allSourceIngredients.find(s => s._id === sourceId);
            document.getElementById('purchaseModal').classList.add('active');
            document.querySelector('#purchaseModal .modal-title').textContent = `Add Purchase for ${source.name}`;
            document.getElementById('purchaseForm').reset();
        }

        async function savePurchase(e) {
            e.preventDefault();
            const data = {
                purchase_quantity: parseFloat(document.getElementById('purchaseQuantity').value),
                purchase_price: parseFloat(document.getElementById('purchasePrice').value)
            };
            
            try {
                const response = await fetch(`${API_URL}/source-ingredients/${editingSourceId}/purchase`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('purchaseModal');
                    showAlert('source-ingredients', 'Purchase added successfully', 'success');
                    loadSourceIngredients();
                }
            } catch (error) {
                showAlert('source-ingredients', 'Error adding purchase', 'error');
            }
        }

        async function deletePurchase(sourceId, purchaseIndex) {
            if (!confirm('Delete this purchase entry?')) return;
            
            try {
                const response = await fetch(`${API_URL}/source-ingredients/${sourceId}/purchase/${purchaseIndex}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('source-ingredients', 'Purchase deleted', 'success');
                    loadSourceIngredients();
                }
            } catch (error) {
                showAlert('source-ingredients', 'Error deleting purchase', 'error');
            }
        }

        async function deleteSourceIngredient(sourceId) {
            if (!confirm('Delete this source ingredient? This will fail if any processed ingredients are linked to it.')) return;
            
            try {
                const response = await fetch(`${API_URL}/source-ingredients/${sourceId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('source-ingredients', 'Source ingredient deleted', 'success');
                    loadSourceIngredients();
                } else {
                    const error = await response.json();
                    showAlert('source-ingredients', error.detail || 'Error deleting source ingredient', 'error');
                }
            } catch (error) {
                showAlert('source-ingredients', 'Error deleting source ingredient', 'error');
            }
        }

        // Delivery Agent Functions
        let allDeliveryAgents = [];
        let agentImage = null;
        let editingAgentId = null;
        let currentOrderForAssignment = null;
        let selectedAgentId = null;
        let agentRefreshInterval = null;
        let currentOrderStatusFilter = 'all';

        async function loadDeliveryAgents() {
            try {
                const agents = await fetch(`${API_URL}/delivery-agents`).then(r => r.json());
                allDeliveryAgents = agents;
                const tbody = document.getElementById('deliveryAgentsBody');
                tbody.innerHTML = agents.map(agent => {
                    const vehicleDisplay = agent.vehicle.charAt(0).toUpperCase() + agent.vehicle.slice(1);
                    return `
                    <tr>
                        <td>${agent.image ? `<img src="${agent.image}" class="table-image">` : '-'}</td>
                        <td>${agent.name}</td>
                        <td>
                            ${agent.email}<br>
                            <small style="color: #666;">${agent.contact_number || 'N/A'}</small>
                        </td>
                        <td>${vehicleDisplay}<br><small>${agent.vehicle_number || 'N/A'}</small></td>
                        <td>‚Çπ${agent.payment_per_delivery || 0}</td>
                        <td>‚Çπ${agent.wallet_balance || 0}</td>
                        <td><span class="status-badge status-${agent.status}">${agent.status}</span></td>
                        <td class="actions">
                            <button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="editDeliveryAgent('${agent._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteDeliveryAgent('${agent._id}')">Delete</button>
                        </td>
                    </tr>
                `;
                }).join('');
            } catch (error) {
                showAlert('delivery', 'Error loading delivery agents', 'error');
            }
        }

        function showDeliveryAgentModal() {
            editingAgentId = null;
            agentImage = null;
            document.getElementById('deliveryAgentModal').classList.add('active');
            document.querySelector('#deliveryAgentModal .modal-title').textContent = 'Add Delivery Agent';
            document.getElementById('deliveryAgentForm').reset();
            document.getElementById('agentImagePreview').innerHTML = '';
        }

        function editDeliveryAgent(agentId) {
            editingAgentId = agentId;
            const agent = allDeliveryAgents.find(a => a._id === agentId);
            if (!agent) return;
            
            document.getElementById('deliveryAgentModal').classList.add('active');
            document.querySelector('#deliveryAgentModal .modal-title').textContent = 'Edit Delivery Agent';
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentEmail').value = agent.email;
            document.getElementById('agentEmail').disabled = false; // CAN change email now
            document.getElementById('agentContactNumber').value = agent.contact_number || '';
            document.getElementById('agentVehicle').value = agent.vehicle;
            document.getElementById('agentVehicleNumber').value = agent.vehicle_number || '';
            document.getElementById('agentPaymentPerDelivery').value = agent.payment_per_delivery || 0;
            
            agentImage = agent.image || null;
            if (agent.image) {
                document.getElementById('agentImagePreview').innerHTML = `
                    <img src="${agent.image}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                `;
            }
        }

        function handleAgentImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    agentImage = e.target.result;
                    document.getElementById('agentImagePreview').innerHTML = `
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveDeliveryAgent(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('agentName').value,
                email: document.getElementById('agentEmail').value,
                contact_number: document.getElementById('agentContactNumber').value,
                vehicle: document.getElementById('agentVehicle').value,
                vehicle_number: document.getElementById('agentVehicleNumber').value,
                payment_per_delivery: parseFloat(document.getElementById('agentPaymentPerDelivery').value) || 0,
                image: agentImage
            };
            
            try {
                let response;
                if (editingAgentId) {
                    // Update existing agent - email CAN be changed now
                    response = await fetch(`${API_URL}/delivery-agents/${editingAgentId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new agent
                    response = await fetch(`${API_URL}/delivery-agents`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeModal('deliveryAgentModal');
                    showAlert('delivery', editingAgentId ? 'Delivery agent updated successfully' : 'Delivery agent created successfully', 'success');
                    loadDeliveryAgents();
                }
            } catch (error) {
                showAlert('delivery', 'Error saving delivery agent', 'error');
            }
        }

        async function deleteDeliveryAgent(agentId) {
            if (!confirm('Delete this delivery agent?')) return;
            
            try {
                const response = await fetch(`${API_URL}/delivery-agents/${agentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('delivery', 'Delivery agent deleted', 'success');
                    loadDeliveryAgents();
                }
            } catch (error) {
                showAlert('delivery', 'Error deleting delivery agent', 'error');
            }
        }

        // Order Management Functions
        async function filterOrdersByStatus(status) {
            currentOrderStatusFilter = status;
            
            // Update active tab
            document.querySelectorAll('.status-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-status') === status) {
                    tab.classList.add('active');
                }
            });
            
            try {
                let orders;
                if (status === 'all') {
                    orders = await fetch(`${API_URL}/admin/orders`).then(r => r.json());
                } else {
                    orders = await fetch(`${API_URL}/orders/by-status/${status}`).then(r => r.json());
                }
                
                updateOrderTableHeaders(status);
                renderOrders(orders);
            } catch (error) {
                console.error('Error loading orders:', error);
                showAlert('orders', 'Error loading orders', 'error');
            }
        }
        
        function updateOrderTableHeaders(status) {
            const thead = document.querySelector('#ordersBody').parentElement.querySelector('thead tr');
            const showAgent = (status === 'ready' || status === 'out_for_delivery' || status === 'delivered' || status === 'all');
            
            if (status === 'all') {
                // All orders: show status column AND actions (delete)
                thead.innerHTML = `
                    <th>Order ID</th>
                    <th>User</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Agent</th>
                    <th>Date</th>
                    <th>Details</th>
                    <th>Actions</th>
                `;
            } else {
                // Specific status tabs: show actions, no status column
                thead.innerHTML = `
                    <th>Order ID</th>
                    <th>User</th>
                    <th>Total</th>
                    <th>Status</th>
                    ${showAgent ? '<th>Agent</th>' : ''}
                    <th>Date</th>
                    <th>Details</th>
                    <th>Actions</th>
                `;
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('ordersBody');
            const showAgent = (currentOrderStatusFilter === 'ready' || currentOrderStatusFilter === 'out_for_delivery' || currentOrderStatusFilter === 'delivered' || currentOrderStatusFilter === 'all');
            
            if (currentOrderStatusFilter === 'all') {
                // All orders tab - simplified view
                tbody.innerHTML = orders.map(order => {
                    return `
                    <tr>
                        <td>${order._id.slice(-8)}</td>
                        <td>
                            <strong>${order.user_name || 'Unknown'}</strong><br>
                            <small>${order.user_email || ''}</small>
                        </td>
                        <td>‚Çπ${(order.final_price || order.total_price || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${order.status}">${order.status.replace(/_/g, ' ')}</span></td>
                        <td>${order.agent_name || '-'}</td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="showOrderDetails('${order._id}')">View Details</button>
                        </td>
                        <td class="actions">
                            <button class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;" onclick="deleteOrder('${order._id}')">Delete</button>
                        </td>
                    </tr>
                `;
                }).join('');
            } else {
                // Specific status tabs - simplified view with action buttons
                tbody.innerHTML = orders.map(order => {
                    const nextStatus = getNextStatus(order.status);
                    
                    return `
                    <tr>
                        <td>${order._id.slice(-8)}</td>
                        <td>
                            <strong>${order.user_name || 'Unknown'}</strong><br>
                            <small>${order.user_email || ''}</small>
                        </td>
                        <td>‚Çπ${(order.final_price || order.total_price || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${order.status}">${order.status.replace(/_/g, ' ')}</span></td>
                        ${showAgent ? `<td>${order.agent_name || '-'}</td>` : ''}
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="showOrderDetails('${order._id}')">View Details</button>
                        </td>
                        <td class="actions">
                            ${order.status === 'ready' && !order.assigned_agent_id ? `
                                <button class="btn" style="font-size: 12px; padding: 6px 12px; margin-bottom: 4px;" onclick="showAssignAgentModal('${order._id}')">Assign Agent</button><br>
                            ` : ''}
                            ${nextStatus ? `
                                <button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="moveOrderForward('${order._id}', '${nextStatus}')">
                                    Move to ${nextStatus.replace(/_/g, ' ')}
                                </button><br>
                            ` : ''}
                            ${order.status !== 'delivered' && order.status !== 'cancelled' ? `
                                <button class="btn btn-danger" style="font-size: 12px; padding: 6px 12px; margin-top: 4px;" onclick="cancelOrder('${order._id}')">Cancel</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                }).join('');
            }
        }
        
        function getNextStatus(currentStatus) {
            const statusFlow = {
                'arrived': 'accepted',
                'accepted': 'preparing',
                'preparing': 'ready',
                'ready': 'out_for_delivery',
                'out_for_delivery': 'delivered'
            };
            return statusFlow[currentStatus] || null;
        }
        
        async function moveOrderForward(orderId, nextStatus) {
            // If moving to out_for_delivery, check if agent is assigned
            if (nextStatus === 'out_for_delivery') {
                const order = await fetch(`${API_URL}/admin/orders`).then(r => r.json()).then(orders => orders.find(o => o._id === orderId));
                if (!order.assigned_agent_id) {
                    showAssignAgentModal(orderId);
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: nextStatus })
                });
                
                if (response.ok) {
                    showAlert('orders', `Order moved to ${nextStatus.replace(/_/g, ' ')}`, 'success');
                    filterOrdersByStatus(currentOrderStatusFilter);
                } else {
                    const error = await response.json();
                    showAlert('orders', error.detail || 'Error updating order status', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showAlert('orders', 'Error updating order status', 'error');
            }
        }
        
        async function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;
            
            try {
                const response = await fetch(`${API_URL}/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'cancelled' })
                });
                
                if (response.ok) {
                    showAlert('orders', 'Order cancelled', 'success');
                    filterOrdersByStatus(currentOrderStatusFilter);
                } else {
                    const error = await response.json();
                    showAlert('orders', error.detail || 'Error cancelling order', 'error');
                }
            } catch (error) {
                console.error('Error cancelling order:', error);
                showAlert('orders', 'Error cancelling order', 'error');
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to DELETE this order? This action cannot be undone.')) return;
            
            try {
                const response = await fetch(`${API_URL}/admin/orders/${orderId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('orders', 'Order deleted successfully', 'success');
                    filterOrdersByStatus(currentOrderStatusFilter);
                } else {
                    showAlert('orders', 'Error deleting order', 'error');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                showAlert('orders', 'Error deleting order', 'error');
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            if (!newStatus) return;
            
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showAlert('orders', 'Order status updated', 'success');
                    filterOrdersByStatus(currentOrderStatusFilter);
                }
            } catch (error) {
                showAlert('orders', 'Error updating order status', 'error');
            }
        }

        async function showAssignAgentModal(orderId) {
            currentOrderForAssignment = orderId;
            selectedAgentId = null;
            document.getElementById('assignAgentModal').classList.add('active');
            document.getElementById('selectedAgentInfo').style.display = 'none';
            document.getElementById('confirmAssignBtn').style.display = 'none';
            
            // Load available agents
            await loadAvailableAgents();
            
            // Start auto-refresh every 5 seconds
            agentRefreshInterval = setInterval(loadAvailableAgents, 5000);
        }
        
        async function loadAvailableAgents() {
            try {
                const agents = await fetch(`${API_URL}/delivery-agents`).then(r => r.json());
                const availableAgents = agents.filter(a => a.status === 'available');
                
                const container = document.getElementById('availableAgentsList');
                if (availableAgents.length === 0) {
                    container.innerHTML = '<p style="color: #ef4444;">No available agents at the moment. Agents must be in "Available" status to receive orders.</p>';
                    return;
                }
                
                container.innerHTML = availableAgents.map(agent => `
                    <div style="border: 2px solid ${selectedAgentId === agent._id ? '#3b82f6' : '#e2e8f0'}; background-color: ${selectedAgentId === agent._id ? '#f0f9ff' : '#fff'}; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" 
                         id="agent-${agent._id}"
                         onmouseover="if(selectedAgentId !== '${agent._id}') this.style.borderColor='#ffd700'" 
                         onmouseout="if(selectedAgentId !== '${agent._id}') this.style.borderColor='#e2e8f0'"
                         onclick="selectAgent('${agent._id}', '${agent.name}', '${agent.vehicle}', '${agent.email}')">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${agent.image ? `<img src="${agent.image}" style="width: 50px; height: 50px; border-radius: 25px;">` : ''}
                            <div>
                                <div style="font-weight: 600; font-size: 16px; color: #334155;">${agent.name}</div>
                                <div style="color: #64748b; font-size: 14px;">${agent.vehicle} ‚Ä¢ ${agent.vehicle_number || 'N/A'}</div>
                                <div style="color: #10b981; font-size: 12px; font-weight: 600; margin-top: 4px;">‚óè Available</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('assignAgentError').textContent = 'Error loading agents';
                document.getElementById('assignAgentError').style.display = 'block';
            }
        }
        function selectAgent(agentId, agentName, agentVehicle, agentEmail) {
            selectedAgentId = agentId;
            
            // Remove selection from all agents
            document.querySelectorAll('[id^="agent-"]').forEach(el => {
                el.style.borderColor = '#e2e8f0';
                el.style.backgroundColor = '#fff';
            });
            
            // Highlight selected agent
            const selectedEl = document.getElementById(`agent-${agentId}`);
            if (selectedEl) {
                selectedEl.style.borderColor = '#3b82f6';
                selectedEl.style.backgroundColor = '#f0f9ff';
            }
            
            // Show selected agent info
            document.getElementById('selectedAgentInfo').style.display = 'block';
            document.getElementById('selectedAgentDetails').innerHTML = `
                <strong>${agentName}</strong><br>
                <small>${agentVehicle} ‚Ä¢ ${agentEmail}</small>
            `;
            
            // Show confirm button
            document.getElementById('confirmAssignBtn').style.display = 'block';
        }

        async function confirmAssignAgent() {
            if (!selectedAgentId) {
                document.getElementById('assignAgentError').textContent = 'Please select an agent';
                document.getElementById('assignAgentError').style.display = 'block';
                return;
            }
            
            try {
                const token = localStorage.getItem('admin_token');
                
                // Assign agent to order
                const assignResponse = await fetch(`${API_URL}/admin/orders/${currentOrderForAssignment}/assign-agent`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ agent_id: selectedAgentId })
                });
                
                if (!assignResponse.ok) {
                    const errorData = await assignResponse.json();
                    throw new Error(errorData.detail || 'Failed to assign agent');
                }
                
                // Move order to out_for_delivery status
                const statusResponse = await fetch(`${API_URL}/admin/orders/${currentOrderForAssignment}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: 'out_for_delivery' })
                });
                
                if (statusResponse.ok) {
                    closeModal('assignAgentModal');
                    showAlert('orders', 'Agent assigned and order moved to Out for Delivery', 'success');
                    filterOrdersByStatus(currentOrderStatusFilter);
                } else {
                    const errorData = await statusResponse.json();
                    throw new Error(errorData.detail || 'Failed to update order status');
                }
            } catch (error) {
                console.error('Error assigning agent:', error);
                document.getElementById('assignAgentError').textContent = 'Error assigning agent: ' + error.message;
                document.getElementById('assignAgentError').style.display = 'block';
            }
        }

        async function assignAgent(agentId) {
            try {
                const response = await fetch(`${API_URL}/orders/${currentOrderForAssignment}/assign-agent`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ agent_id: agentId })
                });
                
                if (response.ok) {
                    closeModal('assignAgentModal');
                    showAlert('orders', 'Agent assigned successfully', 'success');
                    filterOrdersByStatus(currentOrderStatusFilter);
                }
            } catch (error) {
                document.getElementById('assignAgentError').textContent = 'Error assigning agent';
                document.getElementById('assignAgentError').style.display = 'block';
            }
        }

        async function loadIngredients() {
            try {
                const response = await fetch(`${API_URL}/ingredients`);
                if (!response.ok) {
                    throw new Error('Failed to load ingredients');
                }
                const ingredients = await response.json();
                allIngredients = ingredients;
                const tbody = document.getElementById('ingredientsBody');
                
                // Safely render ingredients
                tbody.innerHTML = ingredients.map(ing => {
                    const name = ing.name || 'Unknown';
                    const price = ing.price_per_unit || ing.calculated_price || 0;
                    const unit = ing.unit || '';
                    const tags = ing.tags ? ing.tags.join(', ') : '-';
                    const image = ing.images && ing.images.length > 0 ? `<img src="${ing.images[0]}" class="table-image">` : '-';
                    
                    return `
                        <tr>
                            <td>${image}</td>
                            <td>${name}</td>
                            <td>‚Çπ${price.toFixed(2)}</td>
                            <td>${unit}</td>
                            <td>${tags}</td>
                            <td class="actions">
                                <button class="btn" onclick="editIngredient('${ing._id}')">Edit</button>
                                <button class="btn btn-danger" onclick="deleteIngredient('${ing._id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                updateMealIngredientSelect();
            } catch (error) {
                console.error('Error loading ingredients:', error);
                // Only show alert for network errors
                if (error.message === 'Failed to load ingredients') {
                    showAlert('ingredients', 'Error loading ingredients', 'error');
                }
            }
        }

        // Nutrition Profile Management
        let nutritionEntries = [];
        let sourceIngredientEntries = [];

        function addSourceIngredientEntry() {
            const id = Date.now();
            sourceIngredientEntries.push({ id, source_ingredient_id: '', source_quantity: '' });
            renderSourceIngredientEntries();
            calculateIngredientPrice();
        }

        function removeSourceIngredientEntry(id) {
            sourceIngredientEntries = sourceIngredientEntries.filter(e => e.id !== id);
            renderSourceIngredientEntries();
            calculateIngredientPrice();
        }

        function renderSourceIngredientEntries() {
            const container = document.getElementById('sourceIngredientsContainer');
            if (sourceIngredientEntries.length === 0) {
                container.innerHTML = '<p style="color: #64748b; font-size: 13px; margin: 0;">No source ingredients. Click "+ Add Source" to add.</p>';
                return;
            }
            
            container.innerHTML = sourceIngredientEntries.map(entry => `
                <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <select onchange="updateSourceEntry(${entry.id}, 'source_ingredient_id', this.value); calculateIngredientPrice();"
                        style="flex: 2; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                        <option value="">Select source ingredient</option>
                        ${allSourceIngredients.map(s => `
                            <option value="${s._id}" ${entry.source_ingredient_id === s._id ? 'selected' : ''}>
                                ${s.name} (‚Çπ${s.latest_unit_price.toFixed(2)} per ${s.unit})
                            </option>
                        `).join('')}
                    </select>
                    <input type="number" step="0.01" placeholder="Quantity" value="${entry.source_quantity}"
                        onchange="updateSourceEntry(${entry.id}, 'source_quantity', this.value); calculateIngredientPrice();"
                        style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                    <button type="button" onclick="removeSourceIngredientEntry(${entry.id})" 
                        style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">√ó</button>
                </div>
            `).join('');
        }

        function updateSourceEntry(id, field, value) {
            const entry = sourceIngredientEntries.find(e => e.id === id);
            if (entry) {
                entry[field] = value;
            }
        }

        function addNutritionEntry() {
            const id = Date.now();
            nutritionEntries.push({ id, name: '', value: '', unit: '' });
            renderNutritionEntries();
        }

        function removeNutritionEntry(id) {
            nutritionEntries = nutritionEntries.filter(e => e.id !== id);
            renderNutritionEntries();
        }

        function renderNutritionEntries() {
            const container = document.getElementById('nutritionProfileContainer');
            if (nutritionEntries.length === 0) {
                container.innerHTML = '<p style="color: #64748b; font-size: 13px; margin: 0;">No nutrition entries. Click "+ Add Entry" to add.</p>';
                return;
            }
            
            container.innerHTML = nutritionEntries.map(entry => `
                <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <input type="text" placeholder="e.g., Protein" value="${entry.name}" 
                        onchange="updateNutritionEntry(${entry.id}, 'name', this.value)"
                        style="flex: 2; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                    <input type="number" step="0.01" placeholder="Value" value="${entry.value}"
                        onchange="updateNutritionEntry(${entry.id}, 'value', this.value)"
                        style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                    <input type="text" placeholder="Unit" value="${entry.unit}"
                        onchange="updateNutritionEntry(${entry.id}, 'unit', this.value)"
                        style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px;">
                    <button type="button" onclick="removeNutritionEntry(${entry.id})" 
                        style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">√ó</button>
                </div>
            `).join('');
        }

        function updateNutritionEntry(id, field, value) {
            const entry = nutritionEntries.find(e => e.id === id);
            if (entry) {
                entry[field] = value;
            }
        }

        // Price Calculation based on Source Ingredients (multiple)
        async function calculateIngredientPrice() {
            const priceInput = document.getElementById('ingredientPrice');
            const priceInfo = document.getElementById('priceCalculationInfo');
            
            if (sourceIngredientEntries.length === 0) {
                priceInfo.style.display = 'none';
                priceInput.readOnly = false;
                return;
            }
            
            let totalPrice = 0;
            let calculations = [];
            
            for (const entry of sourceIngredientEntries) {
                if (entry.source_ingredient_id && entry.source_quantity) {
                    const source = allSourceIngredients.find(s => s._id === entry.source_ingredient_id);
                    if (source && source.latest_unit_price) {
                        const itemPrice = parseFloat(entry.source_quantity) * source.latest_unit_price;
                        totalPrice += itemPrice;
                        calculations.push(`${entry.source_quantity} √ó ‚Çπ${source.latest_unit_price.toFixed(2)} (${source.name})`);
                    }
                }
            }
            
            // Add margins to total price
            const productMargin = parseFloat(document.getElementById('productMargin').value) || 0;
            const operationsMargin = parseFloat(document.getElementById('operationsMargin').value) || 0;
            const brandingMargin = parseFloat(document.getElementById('brandingMargin').value) || 0;
            const restMargins = parseFloat(document.getElementById('restMargins').value) || 0;
            const miscellaneousMargins = parseFloat(document.getElementById('miscellaneousMargins').value) || 0;
            
            const totalMargins = productMargin + operationsMargin + brandingMargin + restMargins + miscellaneousMargins;
            const finalPrice = totalPrice + totalMargins;
            
            if (calculations.length > 0) {
                priceInput.value = finalPrice.toFixed(2);
                priceInput.readOnly = true;
                let infoText = `Auto-calculated: ${calculations.join(' + ')} = ‚Çπ${totalPrice.toFixed(2)}`;
                if (totalMargins > 0) {
                    infoText += ` + Margins (‚Çπ${totalMargins.toFixed(2)}) = ‚Çπ${finalPrice.toFixed(2)}`;
                }
                priceInfo.textContent = infoText;
                priceInfo.style.display = 'block';
            } else {
                priceInfo.style.display = 'none';
                priceInput.readOnly = false;
            }
        }

        async function showIngredientModal() {
            editingIngredientId = null;
            nutritionEntries = [];
            sourceIngredientEntries = [];
            document.getElementById('ingredientModal').classList.add('active');
            document.querySelector('#ingredientModal .modal-title').textContent = 'Add Processed Ingredient';
            document.getElementById('ingredientForm').reset();
            document.getElementById('stepSize').value = '1';
            document.getElementById('productMargin').value = '0';
            document.getElementById('operationsMargin').value = '0';
            document.getElementById('brandingMargin').value = '0';
            document.getElementById('restMargins').value = '0';
            document.getElementById('miscellaneousMargins').value = '0';
            ingredientImages = [];
            document.getElementById('ingredientImagePreview').innerHTML = '';
            document.getElementById('priceCalculationInfo').style.display = 'none';
            document.getElementById('ingredientPrice').readOnly = false;
            
            // Load source ingredients if not already loaded
            if (allSourceIngredients.length === 0) {
                try {
                    const sources = await fetch(`${API_URL}/source-ingredients`).then(r => r.json());
                    allSourceIngredients = sources;
                } catch (error) {
                    console.error('Error loading source ingredients:', error);
                }
            }
            
            renderNutritionEntries();
            renderSourceIngredientEntries();
        }

        async function editIngredient(id) {
            editingIngredientId = id;
            const ingredient = allIngredients.find(i => i._id === id);
            if (!ingredient) return;
            
            document.getElementById('ingredientModal').classList.add('active');
            document.querySelector('#ingredientModal .modal-title').textContent = 'Edit Processed Ingredient';
            document.getElementById('ingredientName').value = ingredient.name;
            document.getElementById('ingredientPrice').value = ingredient.price_per_unit;
            document.getElementById('ingredientUnit').value = ingredient.unit;
            document.getElementById('ingredientDescription').value = ingredient.description || '';
            document.getElementById('ingredientTags').value = ingredient.tags ? ingredient.tags.join(', ') : '';
            document.getElementById('stepSize').value = ingredient.step_size || 1;
            
            // Load margin fields
            document.getElementById('productMargin').value = ingredient.product_margin || 0;
            document.getElementById('operationsMargin').value = ingredient.operations_margin || 0;
            document.getElementById('brandingMargin').value = ingredient.branding_margin || 0;
            document.getElementById('restMargins').value = ingredient.rest_margins || 0;
            document.getElementById('miscellaneousMargins').value = ingredient.miscellaneous_margins || 0;
            
            // Load source ingredients if not already loaded
            if (allSourceIngredients.length === 0) {
                try {
                    const sources = await fetch(`${API_URL}/source-ingredients`).then(r => r.json());
                    allSourceIngredients = sources;
                } catch (error) {
                    console.error('Error loading source ingredients:', error);
                }
            }
            
            // Load source ingredients (multiple sources support)
            sourceIngredientEntries = (ingredient.source_ingredients || []).map((src, idx) => ({
                id: Date.now() + idx,
                source_ingredient_id: src.source_ingredient_id,
                source_quantity: src.source_quantity
            }));
            
            // Nutrition profile
            nutritionEntries = (ingredient.nutrition_profile || []).map((entry, idx) => ({
                id: Date.now() + idx + 1000,
                name: entry.name,
                value: entry.value,
                unit: entry.unit
            }));
            
            // Set existing images
            ingredientImages = ingredient.images || [];
            const preview = document.getElementById('ingredientImagePreview');
            preview.innerHTML = ingredientImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview">
                    <button type="button" class="image-remove" onclick="removeIngredientImage(${index})">√ó</button>
                </div>
            `).join('');
            
            renderNutritionEntries();
            renderSourceIngredientEntries();
            if (sourceIngredientEntries.length > 0) {
                calculateIngredientPrice();
            }
        }

        async function saveIngredient(e) {
            e.preventDefault();
            const tags = document.getElementById('ingredientTags').value
                .split(',').map(t => t.trim()).filter(Boolean);
            
            // Prepare nutrition profile
            const nutrition_profile = nutritionEntries
                .filter(e => e.name && e.value && e.unit)
                .map(e => ({
                    name: e.name,
                    value: parseFloat(e.value),
                    unit: e.unit
                }));
            
            // Prepare source ingredients array
            const source_ingredients = sourceIngredientEntries
                .filter(e => e.source_ingredient_id && e.source_quantity)
                .map(e => ({
                    source_ingredient_id: e.source_ingredient_id,
                    source_quantity: parseFloat(e.source_quantity)
                }));
            
            // Get margin values
            const productMargin = parseFloat(document.getElementById('productMargin').value) || 0;
            const operationsMargin = parseFloat(document.getElementById('operationsMargin').value) || 0;
            const brandingMargin = parseFloat(document.getElementById('brandingMargin').value) || 0;
            const restMargins = parseFloat(document.getElementById('restMargins').value) || 0;
            const miscellaneousMargins = parseFloat(document.getElementById('miscellaneousMargins').value) || 0;
            
            const data = {
                name: document.getElementById('ingredientName').value,
                price_per_unit: parseFloat(document.getElementById('ingredientPrice').value),
                unit: document.getElementById('ingredientUnit').value,
                description: document.getElementById('ingredientDescription').value,
                tags: tags,
                images: ingredientImages,
                step_size: parseFloat(document.getElementById('stepSize').value) || 1.0,
                nutrition_profile: nutrition_profile,
                source_ingredients: source_ingredients,
                product_margin: productMargin,
                operations_margin: operationsMargin,
                branding_margin: brandingMargin,
                rest_margins: restMargins,
                miscellaneous_margins: miscellaneousMargins
            };
            
            try {
                let response;
                if (editingIngredientId) {
                    // Update existing ingredient
                    response = await fetch(`${API_URL}/admin/ingredients/${editingIngredientId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new ingredient
                    response = await fetch(`${API_URL}/admin/ingredients`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeModal('ingredientModal');
                    showAlert('ingredients', editingIngredientId ? 'Processed ingredient updated successfully' : 'Processed ingredient created successfully', 'success');
                    loadIngredients();
                }
            } catch (error) {
                showAlert('ingredients', 'Error saving processed ingredient', 'error');
            }
        }

        async function deleteIngredient(id) {
            if (!confirm('Delete this ingredient?')) return;
            try {
                await fetch(`${API_URL}/admin/ingredients/${id}`, { method: 'DELETE' });
                showAlert('ingredients', 'Deleted successfully', 'success');
                loadIngredients();
            } catch (error) {
                showAlert('ingredients', 'Error deleting', 'error');
            }
        }

        async function loadMeals() {
            try {
                const recipes = await fetch(`${API_URL}/recipes`).then(r => r.json());
                allRecipes = recipes; // Store for use in combo creation
                const tbody = document.getElementById('mealsBody');
                tbody.innerHTML = recipes.map(recipe => `
                    <tr>
                        <td>${recipe.images && recipe.images.length > 0 ? `<img src="${recipe.images[0]}" class="table-image">` : '-'}</td>
                        <td>${recipe.name}</td>
                        <td>${recipe.description}</td>
                        <td>‚Çπ${recipe.calculated_price ? recipe.calculated_price.toFixed(2) : '0.00'}</td>
                        <td>${recipe.tags ? recipe.tags.join(', ') : '-'}</td>
                        <td class="actions">
                            <button class="btn" onclick="editMeal('${recipe._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMeal('${recipe._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('meals', 'Error loading meals', 'error');
            }
        }

        // Recipe Management Functions
        let recipeImages = [];
        let selectedRecipeIngredients = [];
        let editingRecipeId = null;
        let allRecipes = [];

        function showMealModal() {
            editingMealId = null;
            document.getElementById('mealModal').classList.add('active');
            document.querySelector('#mealModal .modal-title').textContent = 'Add Meal';
            document.getElementById('mealForm').reset();
            selectedMealIngredients = [];
            mealImages = [];
            document.getElementById('mealIngredients').innerHTML = '';
            document.getElementById('mealImagePreview').innerHTML = '';
            document.getElementById('mealPrice').value = '0.00';
            updateMealIngredientSelect();
        }

        function updateMealIngredientSelect() {
            const select = document.getElementById('mealIngredientSelect');
            select.innerHTML = '<option value="">-- Select processed ingredient --</option>' +
                allIngredients.map(ing => `<option value="${ing._id}">${ing.name} (‚Çπ${ing.calculated_price ? ing.calculated_price.toFixed(2) : '0.00'}/${ing.unit})</option>`).join('');
        }

        function addIngredientToMeal() {
            const select = document.getElementById('mealIngredientSelect');
            const ingredientId = select.value;
            if (!ingredientId) return alert('Please select a processed ingredient');
            
            const ingredient = allIngredients.find(i => i._id === ingredientId);
            if (!ingredient) return;
            
            if (selectedMealIngredients.find(i => i.ingredient_id === ingredientId)) {
                return alert('Ingredient already added');
            }
            
            selectedMealIngredients.push({
                ingredient_id: ingredientId,
                name: ingredient.name,
                quantity: 1.0,
                unit: ingredient.unit,
                default_step_size: ingredient.step_size || 1.0,
                step_size: ingredient.step_size || 1.0,
                price: ingredient.calculated_price || 0
            });
            
            renderMealIngredients();
            updateMealPrice();
        }

        function renderMealIngredients() {
            document.getElementById('mealIngredients').innerHTML = selectedMealIngredients.map((ing, idx) => `
                <div class="ingredient-item">
                    <span>${ing.name}</span>
                    <input type="number" min="0.01" step="any" value="${ing.quantity}" 
                           onchange="updateMealIngredientQuantity(${idx}, this.value)" 
                           placeholder="Quantity"
                           style="width: 80px;">
                    <span>${ing.unit}</span>
                    <input type="number" min="0.01" step="0.01" value="${ing.step_size || ing.default_step_size || 1.0}" 
                           onchange="updateMealIngredientStepSize(${idx}, this.value)" 
                           placeholder="Step override" 
                           style="width: 100px; margin-left: 10px;" 
                           title="Step size override (optional)">
                    <span>‚Çπ${(ing.price * ing.quantity).toFixed(2)}</span>
                    <button type="button" onclick="removeIngredientFromMeal(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function updateMealIngredientQuantity(index, quantity) {
            selectedMealIngredients[index].quantity = parseFloat(quantity);
            renderMealIngredients();
            updateMealPrice();
        }

        function updateMealIngredientStepSize(index, stepSize) {
            selectedMealIngredients[index].step_size = parseFloat(stepSize);
        }

        function removeIngredientFromMeal(index) {
            selectedMealIngredients.splice(index, 1);
            renderMealIngredients();
            updateMealPrice();
        }

        function updateMealPrice() {
            const total = selectedMealIngredients.reduce((sum, ing) => sum + (ing.price * ing.quantity), 0);
            document.getElementById('mealPrice').value = total.toFixed(2);
        }

        function handleMealImages(event) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mealImages.push(e.target.result);
                    updateMealImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateMealImagePreview() {
            const preview = document.getElementById('mealImagePreview');
            preview.innerHTML = mealImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview">
                    <button type="button" class="image-remove" onclick="removeMealImage(${index})">√ó</button>
                </div>
            `).join('');
        }

        function removeMealImage(index) {
            mealImages.splice(index, 1);
            updateMealImagePreview();
        }

        async function saveMeal(e) {
            e.preventDefault();
            if (selectedMealIngredients.length === 0) return alert('Add at least one processed ingredient');
            
            const tags = document.getElementById('mealTags').value
                .split(',').map(t => t.trim()).filter(Boolean);
            
            const categories = document.getElementById('mealCategories').value
                .split(',').map(t => t.trim()).filter(Boolean);
            
            const data = {
                name: document.getElementById('mealName').value,
                description: document.getElementById('mealDescription').value,
                ingredients: selectedMealIngredients,
                tags: tags,
                categories: categories,
                images: mealImages,
                created_by: 'admin'
            };
            
            try {
                let response;
                if (editingMealId) {
                    response = await fetch(`${API_URL}/recipes/${editingMealId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`${API_URL}/recipes`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeModal('mealModal');
                    showAlert('recipes', editingMealId ? 'Recipe updated successfully' : 'Recipe created successfully', 'success');
                    loadMeals();
                } else {
                    const error = await response.json();
                    showAlert('recipes', error.detail || 'Error saving recipe', 'error');
                }
            } catch (error) {
                showAlert('recipes', 'Error saving recipe', 'error');
            }
        }

        async function editMeal(id) {
            editingMealId = id;
            try {
                const response = await fetch(`${API_URL}/recipes/${id}`);
                const meal = await response.json();
                
                document.getElementById('mealModal').classList.add('active');
                document.querySelector('#mealModal .modal-title').textContent = 'Edit Recipe';
                document.getElementById('mealName').value = meal.name;
                document.getElementById('mealDescription').value = meal.description;
                document.getElementById('mealPrice').value = meal.calculated_price || 0;
                document.getElementById('mealTags').value = meal.tags ? meal.tags.join(', ') : '';
                document.getElementById('mealCategories').value = meal.categories ? meal.categories.join(', ') : '';
                
                // Set existing images
                mealImages = meal.images || [];
                const preview = document.getElementById('mealImagePreview');
                preview.innerHTML = mealImages.map((img, index) => `
                    <div class="image-preview-item">
                        <img src="${img}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeMealImage(${index})">√ó</button>
                    </div>
                `).join('');
                
                // Set existing ingredients
                selectedMealIngredients = meal.ingredients || [];
                updateMealIngredientSelect();
                renderMealIngredients();
                updateMealPrice();
            } catch (error) {
                showAlert('recipes', 'Error loading recipe data', 'error');
            }
        }

        async function deleteMeal(id) {
            if (!confirm('Delete this meal?')) return;
            try {
                const response = await fetch(`${API_URL}/recipes/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showAlert('meals', 'Deleted successfully', 'success');
                    loadMeals();
                } else {
                    showAlert('meals', 'Error deleting meal', 'error');
                }
            } catch (error) {
                showAlert('meals', 'Error deleting', 'error');
            }
        }

        async function loadCombos() {
            try {
                const combos = await fetch(`${API_URL}/meals`).then(r => r.json());
                const tbody = document.getElementById('combosBody');
                tbody.innerHTML = combos.map(combo => `
                    <tr>
                        <td>${combo.images && combo.images.length > 0 ? `<img src="${combo.images[0]}" class="table-image">` : '-'}</td>
                        <td>${combo.name}</td>
                        <td>${combo.recipes ? combo.recipes.length + ' meal(s)' : '-'}</td>
                        <td>‚Çπ${combo.calculated_price ? combo.calculated_price.toFixed(2) : '0.00'}</td>
                        <td>${combo.tags ? combo.tags.join(', ') : '-'}</td>
                        <td class="actions">
                            <button class="btn" onclick="editCombo('${combo._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteCombo('${combo._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('combos', 'Error loading combos', 'error');
            }
        }

        // Meal Management Functions (working with recipes)
        let selectedMealRecipes = [];

        function showComboModal() {
            editingComboId = null;
            document.getElementById('comboModal').classList.add('active');
            document.querySelector('#comboModal .modal-title').textContent = 'Add Combo';
            document.getElementById('comboForm').reset();
            selectedComboMeals = [];
            comboImages = [];
            document.getElementById('comboMeals').innerHTML = '';
            document.getElementById('comboImagePreview').innerHTML = '';
            document.getElementById('comboPrice').value = '0.00';
            updateComboMealSelect();
        }

        async function editCombo(id) {
            editingComboId = id;
            try {
                const response = await fetch(`${API_URL}/meals/${id}`);
                const combo = await response.json();
                
                document.getElementById('comboModal').classList.add('active');
                document.querySelector('#comboModal .modal-title').textContent = 'Edit Combo';
                document.getElementById('comboName').value = combo.name;
                document.getElementById('comboDescription').value = combo.description;
                document.getElementById('comboPrice').value = combo.calculated_price || 0;
                document.getElementById('comboTags').value = combo.tags ? combo.tags.join(', ') : '';
                
                // Set existing images
                comboImages = combo.images || [];
                const preview = document.getElementById('comboImagePreview');
                preview.innerHTML = comboImages.map((img, index) => `
                    <div class="image-preview-item">
                        <img src="${img}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeComboImage(${index})">√ó</button>
                    </div>
                `).join('');
                
                // Set existing meals (stored as recipes in backend)
                selectedComboMeals = combo.recipes || [];
                updateComboMealSelect();
                renderComboMeals();
                updateComboPrice();
            } catch (error) {
                showAlert('combos', 'Error loading combo data', 'error');
            }
        }

        function updateComboMealSelect() {
            const select = document.getElementById('comboMealSelect');
            select.innerHTML = '<option value="">-- Select meal --</option>' +
                allRecipes.map(meal => `<option value="${meal._id}">${meal.name} (‚Çπ${meal.calculated_price ? meal.calculated_price.toFixed(2) : '0.00'})</option>`).join('');
        }

        function addMealToCombo() {
            const select = document.getElementById('comboMealSelect');
            const mealId = select.value;
            if (!mealId) return alert('Please select a meal');
            
            const meal = allRecipes.find(m => m._id === mealId);
            if (!meal) return;
            
            if (selectedComboMeals.find(m => m.recipe_id === mealId)) {
                return alert('Meal already added');
            }
            
            selectedComboMeals.push({
                recipe_id: mealId,
                name: meal.name,
                quantity: 1.0,
                step_size: 0.5,
                price: meal.calculated_price || 0
            });
            
            renderComboMeals();
            updateComboPrice();
        }

        function renderComboMeals() {
            document.getElementById('comboMeals').innerHTML = selectedComboMeals.map((meal, idx) => `
                <div class="ingredient-item">
                    <span>${meal.name}</span>
                    <input type="number" min="0.01" step="any" value="${meal.quantity}" 
                           onchange="updateComboMealQuantity(${idx}, this.value)">
                    <span>x</span>
                    <span>‚Çπ${(meal.price * meal.quantity).toFixed(2)}</span>
                    <button type="button" onclick="removeMealFromCombo(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function updateComboMealQuantity(index, quantity) {
            selectedComboMeals[index].quantity = parseFloat(quantity);
            renderComboMeals();
            updateComboPrice();
        }

        function removeMealFromCombo(index) {
            selectedComboMeals.splice(index, 1);
            renderComboMeals();
            updateComboPrice();
        }

        function updateComboPrice() {
            const total = selectedComboMeals.reduce((sum, meal) => sum + (meal.price * meal.quantity), 0);
            document.getElementById('comboPrice').value = total.toFixed(2);
        }

        function handleComboImages(event) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    comboImages.push(e.target.result);
                    updateComboImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateComboImagePreview() {
            const preview = document.getElementById('comboImagePreview');
            preview.innerHTML = comboImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview">
                    <button type="button" class="image-remove" onclick="removeComboImage(${index})">√ó</button>
                </div>
            `).join('');
        }

        function removeComboImage(index) {
            comboImages.splice(index, 1);
            updateComboImagePreview();
        }


        function updateMealRecipeSelect() {
            const select = document.getElementById('mealRecipeSelect');
            select.innerHTML = '<option value="">-- Select recipe --</option>' +
                allRecipes.map(recipe => `<option value="${recipe._id}">${recipe.name} (‚Çπ${recipe.calculated_price ? recipe.calculated_price.toFixed(2) : '0.00'})</option>`).join('');
        }

        function addRecipeToMeal() {
            const select = document.getElementById('mealRecipeSelect');
            const recipeId = select.value;
            if (!recipeId) return alert('Please select a recipe');
            
            const recipe = allRecipes.find(r => r._id === recipeId);
            if (!recipe) return;
            
            if (selectedMealRecipes.find(r => r.recipe_id === recipeId)) {
                return alert('Recipe already added');
            }
            
            selectedMealRecipes.push({
                recipe_id: recipeId,
                name: recipe.name,
                quantity: 1.0,
                step_size: 0.5,
                price: recipe.calculated_price || 0
            });
            
            renderMealRecipes();
            updateMealPrice();
        }

        function renderMealRecipes() {
            document.getElementById('mealRecipes').innerHTML = selectedMealRecipes.map((recipe, idx) => `
                <div class="ingredient-item">
                    <span>${recipe.name}</span>
                    <input type="number" min="0.01" step="any" value="${recipe.quantity}" 
                           onchange="updateMealRecipeQuantity(${idx}, this.value)">
                    <span>x</span>
                    <span>‚Çπ${(recipe.price * recipe.quantity).toFixed(2)}</span>
                    <button type="button" onclick="removeRecipeFromMeal(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function updateMealRecipeQuantity(index, quantity) {
            selectedMealRecipes[index].quantity = parseFloat(quantity);
            renderMealRecipes();
            updateMealPrice();
        }

        function removeRecipeFromMeal(index) {
            selectedMealRecipes.splice(index, 1);
            renderMealRecipes();
            updateMealPrice();
        }

        function updateMealPrice() {
            const total = selectedMealRecipes.reduce((sum, recipe) => sum + (recipe.price * recipe.quantity), 0);
            document.getElementById('mealPrice').value = total.toFixed(2);
        }

        async function saveCombo(e) {
            e.preventDefault();
            if (selectedComboMeals.length === 0) return alert('Add at least one meal');
            
            const tags = document.getElementById('comboTags').value
                .split(',').map(t => t.trim()).filter(Boolean);
            
            // Backend expects "recipes" field for meals
            const data = {
                name: document.getElementById('comboName').value,
                description: document.getElementById('comboDescription').value,
                recipes: selectedComboMeals,
                tags: tags,
                images: comboImages,
                is_preset: true,
                created_by: 'admin'
            };
            
            try {
                let response;
                if (editingComboId) {
                    // Update existing combo
                    response = await fetch(`${API_URL}/meals/${editingComboId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new combo
                    response = await fetch(`${API_URL}/meals`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeModal('comboModal');
                    showAlert('combos', editingComboId ? 'Combo updated successfully' : 'Combo created successfully', 'success');
                    loadCombos();
                } else {
                    const error = await response.json();
                    showAlert('combos', error.detail || 'Error saving combo', 'error');
                }
            } catch (error) {
                showAlert('combos', 'Error saving combo', 'error');
            }
        }

        function handleMealImages(event) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mealImages.push(e.target.result);
                    updateMealImagePreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateMealImagePreview() {
            const preview = document.getElementById('mealImagePreview');
            preview.innerHTML = mealImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview">
                    <button type="button" class="image-remove" onclick="removeMealImage(${index})">√ó</button>
                </div>
            `).join('');
        }

        function removeMealImage(index) {
            mealImages.splice(index, 1);
            updateMealImagePreview();
        }

        async function deleteCombo(id) {
            if (!confirm('Delete this combo?')) return;
            try {
                const response = await fetch(`${API_URL}/meals/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showAlert('combos', 'Deleted successfully', 'success');
                    loadCombos();
                } else {
                    showAlert('combos', 'Error deleting combo', 'error');
                }
            } catch (error) {
                showAlert('combos', 'Error deleting', 'error');
            }
        }

        async function loadUsers() {
            try {
                const users = await fetch(`${API_URL}/admin/users`).then(r => r.json());
                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.points}</td>
                        <td>${user.inherent_points}</td>
                        <td>${user.star_rating} ‚≠ê</td>
                        <td>${user.is_guide ? 'Yes' : 'No'}</td>
                        <td class="actions">
                            <button class="btn" onclick="showUserPointsModal('${user._id}', '${user.name}', ${user.points}, ${user.inherent_points})">
                                Update
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('users', 'Error loading users', 'error');
            }
        }

        function showUserPointsModal(id, name, points, inherentPoints) {
            document.getElementById('userPointsModal').classList.add('active');
            document.getElementById('userId').value = id;
            document.getElementById('userName').value = name;
            document.getElementById('currentPoints').value = points;
            document.getElementById('inherentPoints').value = inherentPoints;
        }

        async function saveUserPoints(e) {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const inherentPoints = parseInt(document.getElementById('inherentPoints').value);
            try {
                const response = await fetch(`${API_URL}/admin/users/${userId}/points`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ inherent_points: inherentPoints })
                });
                if (response.ok) {
                    closeModal('userPointsModal');
                    showAlert('users', 'Points updated successfully', 'success');
                    loadUsers();
                }
            } catch (error) {
                showAlert('users', 'Error updating points', 'error');
            }
        }

        async function loadOrders() {
            // Initialize orders tab with "all" filter
            currentOrderStatusFilter = 'all';
            document.querySelectorAll('.status-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.status-tab').classList.add('active'); // First tab (All)
            
            try {
                const orders = await fetch(`${API_URL}/admin/orders`).then(r => r.json());
                updateOrderTableHeaders('all');
                renderOrders(orders);
            } catch (error) {
                console.error('Error loading orders:', error);
                showAlert('orders', 'Error loading orders', 'error');
            }
        }
        
        function toggleOrderDetails(orderId) {
            const detailsRow = document.getElementById(`details-${orderId}`);
            if (detailsRow) {
                detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                await fetch(`${API_URL}/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status })
                });
                showAlert('orders', 'Order status updated', 'success');
            } catch (error) {
                showAlert('orders', 'Error updating order', 'error');
            }
        }

        let starRatings = {};
        let commissionRates = {};

        function renderStarRatings() {
            const container = document.getElementById('starRatingsList');
            const sortedKeys = Object.keys(starRatings).sort((a, b) => {
                const numA = parseInt(a.replace('star', ''));
                const numB = parseInt(b.replace('star', ''));
                return numA - numB;
            });
            
            container.innerHTML = sortedKeys.map((key, index) => {
                const starNum = parseInt(key.replace('star', ''));
                const isFirst = index === 0;
                const commissionValue = commissionRates[key] || 0;
                return `
                    <div class="config-item">
                        <div style="min-width: 150px;">
                            <span class="config-label">${starNum}‚≠ê</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" class="config-input" id="${key}" value="${starRatings[key]}" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px; min-width: 180px;">${isFirst ? 'points (Becomes Guide)' : 'points'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" class="config-input" id="commission_${key}" value="${commissionValue}" min="0" max="100" step="0.5" style="width: 120px;">
                            <span style="color: #64748b; font-size: 13px; min-width: 140px;">% commission</span>
                        </div>
                        ${!isFirst ? `<button class="btn-danger" style="padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px;" onclick="removeStarRating('${key}')">Remove</button>` : '<div style="width: 90px;"></div>'}
                    </div>
                `;
            }).join('');
        }

        function addStarRating() {
            const maxStar = Math.max(...Object.keys(starRatings).map(k => parseInt(k.replace('star', ''))));
            const newStarNum = maxStar + 1;
            const prevPoints = starRatings[`star${maxStar}`] || 0;
            const prevCommission = commissionRates[`star${maxStar}`] || 0;
            starRatings[`star${newStarNum}`] = Math.ceil(prevPoints * 1.5);
            commissionRates[`star${newStarNum}`] = Math.min(prevCommission + 3, 100);
            renderStarRatings();
        }

        function removeStarRating(key) {
            if (Object.keys(starRatings).length <= 1) {
                return alert('You must have at least one star rating level');
            }
            delete starRatings[key];
            delete commissionRates[key];
            renderStarRatings();
        }

        function loadSettings() {
            // Load star rating configuration from backend
            fetch(`${API_URL}/admin/star-config`)
                .then(r => r.json())
                .then(config => {
                    starRatings = config;
                    renderStarRatings();
                })
                .catch(error => {
                    console.error('Error loading star config:', error);
                    // Default configuration
                    starRatings = {
                        star1: 25,
                        star2: 100,
                        star3: 250,
                        star4: 500,
                        star5: 1000
                    };
                    renderStarRatings();
                });
            
            // Load commission rates configuration
            fetch(`${API_URL}/admin/commission-rates`)
                .then(r => r.json())
                .then(config => {
                    commissionRates = config;
                    renderStarRatings();
                })
                .catch(error => {
                    console.error('Error loading commission rates:', error);
                    // Default commission rates
                    commissionRates = {
                        star1: 3,
                        star2: 6,
                        star3: 9,
                        star4: 12,
                        star5: 15
                    };
                    renderStarRatings();
                });
            
            // Load points configuration
            loadPointsConfig();
        }

        async function saveStarConfig() {
            // Update star rating values from inputs
            Object.keys(starRatings).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    starRatings[key] = parseInt(input.value);
                }
            });
            
            // Update commission rate values from inputs
            Object.keys(starRatings).forEach(key => {
                const commissionInput = document.getElementById(`commission_${key}`);
                if (commissionInput) {
                    commissionRates[key] = parseFloat(commissionInput.value);
                }
            });
            
            try {
                // Save star ratings
                const starResponse = await fetch(`${API_URL}/admin/star-config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(starRatings)
                });
                
                // Save commission rates
                const commissionResponse = await fetch(`${API_URL}/admin/commission-rates`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(commissionRates)
                });
                
                if (starResponse.ok && commissionResponse.ok) {
                    showAlert('settings', 'Configuration saved successfully!', 'success');
                } else {
                    showAlert('settings', 'Error saving configuration', 'error');
                }
            } catch (error) {
                showAlert('settings', 'Error saving configuration', 'error');
                console.error('Error saving star config:', error);
            }
        }

        function loadPointsConfig() {
            fetch(`${API_URL}/admin/points-config`)
                .then(r => r.json())
                .then(config => {
                    document.getElementById('pointsPerPost').value = config.post || 5;
                    document.getElementById('pointsPerLike').value = config.like || 2;
                    document.getElementById('pointsPerFan').value = config.fan || 3;
                    document.getElementById('pointsPerGuidee').value = config.guidee || 5;
                })
                .catch(error => {
                    console.error('Error loading points config:', error);
                });
        }

        async function savePointsConfig() {
            const config = {
                post: parseInt(document.getElementById('pointsPerPost').value),
                like: parseInt(document.getElementById('pointsPerLike').value),
                fan: parseInt(document.getElementById('pointsPerFan').value),
                guidee: parseInt(document.getElementById('pointsPerGuidee').value)
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/points-config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showAlert('points', 'Points configuration saved successfully!', 'success');
                } else {
                    showAlert('points', 'Error saving points configuration', 'error');
                }
            } catch (error) {
                showAlert('points', 'Error saving points configuration', 'error');
                console.error('Error saving points config:', error);
            }
        }


        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Clear auto-refresh when closing assign agent modal
            if (modalId === 'assignAgentModal' && agentRefreshInterval) {
                clearInterval(agentRefreshInterval);
                agentRefreshInterval = null;
            }
        }

        function showAlert(section, message, type) {
            const alertDiv = document.getElementById(`alert-${section}`);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 3000);
        }

        // Initialize
        loadDashboard();


        // Coupons Management
        async function loadCoupons() {
            try {
                const coupons = await fetch(`${API_URL}/admin/coupons`).then(r => r.json());
                const tbody = document.getElementById('couponsTableBody');
                tbody.innerHTML = coupons.map(coupon => {
                    const isExpired = new Date(coupon.expiry_date) < new Date();
                    const statusBadge = coupon.active && !isExpired 
                        ? '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Active</span>'
                        : '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">' + (isExpired ? 'Expired' : 'Inactive') + '</span>';
                    
                    return `
                        <tr>
                            <td><strong>${coupon.code}</strong></td>
                            <td>${coupon.discount_type === 'percentage' ? 'Percentage' : 'Flat'}</td>
                            <td>${coupon.discount_type === 'percentage' ? coupon.discount_value + '%' : '‚Çπ' + coupon.discount_value}</td>
                            <td>‚Çπ${coupon.min_order_value}</td>
                            <td>${coupon.usage_limit_type === 'one_time' ? 'One Time' : 'Recurring'}</td>
                            <td>${new Date(coupon.expiry_date).toLocaleDateString()}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button onclick="editCoupon('${coupon._id}')" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">Edit</button>
                                <button onclick="deleteCoupon('${coupon._id}')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading coupons:', error);
                showAlert('coupons', 'Error loading coupons', 'error');
            }
        }

        function showAddCouponModal() {
            editingCouponId = null;
            document.getElementById('couponModalTitle').textContent = 'Add Coupon';
            document.getElementById('couponForm').reset();
            document.getElementById('couponActive').checked = true;
            // Set default expiry to 30 days from now
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 30);
            document.getElementById('couponExpiryDate').value = futureDate.toISOString().slice(0, 16);
            openModal('couponModal');
        }

        async function editCoupon(couponId) {
            try {
                const coupons = await fetch(`${API_URL}/admin/coupons`).then(r => r.json());
                const coupon = coupons.find(c => c._id === couponId);
                
                if (coupon) {
                    editingCouponId = couponId;
                    document.getElementById('couponModalTitle').textContent = 'Edit Coupon';
                    document.getElementById('couponCode').value = coupon.code;
                    document.getElementById('couponDiscountType').value = coupon.discount_type;
                    document.getElementById('couponDiscountValue').value = coupon.discount_value;
                    document.getElementById('couponMinOrder').value = coupon.min_order_value;
                    document.getElementById('couponUsageLimitType').value = coupon.usage_limit_type;
                    document.getElementById('couponExpiryDate').value = new Date(coupon.expiry_date).toISOString().slice(0, 16);
                    document.getElementById('couponActive').checked = coupon.active;
                    updateDiscountLabel();
                    openModal('couponModal');
                }
            } catch (error) {
                showAlert('coupons', 'Error loading coupon', 'error');
            }
        }

        async function saveCoupon(event) {
            event.preventDefault();
            
            const couponData = {
                code: document.getElementById('couponCode').value.toUpperCase(),
                discount_type: document.getElementById('couponDiscountType').value,
                discount_value: parseFloat(document.getElementById('couponDiscountValue').value),
                min_order_value: parseFloat(document.getElementById('couponMinOrder').value),
                usage_limit_type: document.getElementById('couponUsageLimitType').value,
                expiry_date: new Date(document.getElementById('couponExpiryDate').value).toISOString(),
                active: document.getElementById('couponActive').checked
            };

            try {
                const url = editingCouponId 
                    ? `${API_URL}/admin/coupons/${editingCouponId}`
                    : `${API_URL}/admin/coupons`;
                
                const method = editingCouponId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(couponData)
                });

                if (response.ok) {
                    showAlert('coupons', editingCouponId ? 'Coupon updated successfully!' : 'Coupon created successfully!', 'success');
                    closeModal('couponModal');
                    loadCoupons();
                } else {
                    showAlert('coupons', 'Error saving coupon', 'error');
                }
            } catch (error) {
                showAlert('coupons', 'Error saving coupon', 'error');
            }
        }

        async function deleteCoupon(couponId) {
            if (!confirm('Are you sure you want to delete this coupon?')) return;

            try {
                const response = await fetch(`${API_URL}/admin/coupons/${couponId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('coupons', 'Coupon deleted successfully!', 'success');
                    loadCoupons();
                } else {
                    showAlert('coupons', 'Error deleting coupon', 'error');
                }
            } catch (error) {
                showAlert('coupons', 'Error deleting coupon', 'error');
            }
        }

        function updateDiscountLabel() {
            const type = document.getElementById('couponDiscountType').value;
            const label = document.getElementById('discountValueLabel');
            label.textContent = type === 'percentage' ? 'Discount Percentage (%) *' : 'Discount Amount (‚Çπ) *';
        }

        // Withdrawals Management
        async function loadWithdrawals() {
            try {
                const withdrawals = await fetch(`${API_URL}/admin/withdrawals`).then(r => r.json());
                const tbody = document.getElementById('withdrawalsTableBody');
                tbody.innerHTML = withdrawals.map(withdrawal => {
                    const statusBadge = 
                        withdrawal.status === 'approved' 
                            ? '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Approved</span>'
                        : withdrawal.status === 'rejected'
                            ? '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Rejected</span>'
                            : '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Pending</span>';
                    
                    return `
                        <tr>
                            <td>${withdrawal.guide_name}</td>
                            <td><strong>‚Çπ${withdrawal.amount.toFixed(2)}</strong></td>
                            <td>${new Date(withdrawal.created_at).toLocaleDateString()}</td>
                            <td>${statusBadge}</td>
                            <td>${withdrawal.processed_at ? new Date(withdrawal.processed_at).toLocaleDateString() : '-'}</td>
                            <td>
                                ${withdrawal.status === 'pending' ? `
                                    <button onclick="approveWithdrawal('${withdrawal._id}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">Approve</button>
                                    <button onclick="rejectWithdrawal('${withdrawal._id}')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Reject</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading withdrawals:', error);
                showAlert('withdrawals', 'Error loading withdrawal requests', 'error');
            }
        }

        async function approveWithdrawal(withdrawalId) {
            if (!confirm('Are you sure you want to approve this withdrawal request?')) return;

            try {
                const response = await fetch(`${API_URL}/admin/withdrawals/${withdrawalId}/approve`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showAlert('withdrawals', 'Withdrawal approved successfully!', 'success');
                    loadWithdrawals();
                } else {
                    const error = await response.json();
                    showAlert('withdrawals', error.detail || 'Error approving withdrawal', 'error');
                }
            } catch (error) {
                showAlert('withdrawals', 'Error approving withdrawal', 'error');
            }
        }

        async function rejectWithdrawal(withdrawalId) {
            if (!confirm('Are you sure you want to reject this withdrawal request?')) return;

            try {
                const response = await fetch(`${API_URL}/admin/withdrawals/${withdrawalId}/reject`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showAlert('withdrawals', 'Withdrawal rejected successfully!', 'success');
                    loadWithdrawals();
                } else {
                    showAlert('withdrawals', 'Error rejecting withdrawal', 'error');
                }
            } catch (error) {
                showAlert('withdrawals', 'Error rejecting withdrawal', 'error');
            }
        }

        // Admin credentials management
        async function changeAdminCredentials(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newEmail = document.getElementById('newEmail').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (newPassword && newPassword !== confirmPassword) {
                showAlert('credentials', 'New passwords do not match', 'error');
                return;
            }
            
            if (!newEmail && !newPassword) {
                showAlert('credentials', 'Please enter at least one new credential', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/change-credentials`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_email: newEmail || undefined,
                        new_password: newPassword || undefined
                    })
                });
                
                if (response.ok) {
                    showAlert('credentials', 'Credentials updated successfully!', 'success');
                    document.getElementById('credentialsForm').reset();
                } else {
                    const error = await response.json();
                    showAlert('credentials', error.detail || 'Error updating credentials', 'error');
                }
            } catch (error) {
                console.error('Error updating credentials:', error);
                showAlert('credentials', 'Error updating credentials', 'error');
            }
        }
        
        async function adminLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            try {
                await fetch(`${API_URL}/admin/logout`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('admin_token');
            window.location.href = '/api/admin-login';
        }
        
        // Order details modal
        async function showOrderDetails(orderId) {
            try {
                const response = await fetch(`${API_URL}/admin/orders/${orderId}`);
                if (!response.ok) {
                    showAlert('orders', 'Error loading order details', 'error');
                    return;
                }
                
                const order = await response.json();
                const modal = document.getElementById('orderDetailsModal');
                const content = document.getElementById('orderDetailsContent');
                
                // Calculate totals
                const itemsTotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                content.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div>
                                <h3 style="margin-bottom: 12px; color: #1e293b;">üì¶ Order Information</h3>
                                <p><strong>Order ID:</strong> ${order._id}</p>
                                <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status}</span></p>
                                <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                                ${order.delivered_at ? `<p><strong>Delivered:</strong> ${new Date(order.delivered_at).toLocaleString()}</p>` : ''}
                            </div>
                            <div>
                                <h3 style="margin-bottom: 12px; color: #1e293b;">üë§ Customer Information</h3>
                                <p><strong>Name:</strong> ${order.user_name || 'N/A'}</p>
                                <p><strong>Email:</strong> ${order.user_email || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 12px; color: #1e293b;">üìã Order Items</h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => {
                                        let itemRow = `
                                            <tr>
                                                <td>
                                                    <strong>${item.meal_name}</strong>
                                                    ${item.customizations && item.customizations.length > 0 ? `
                                                        <div style="margin-top: 8px; padding-left: 12px; border-left: 3px solid #ffd700;">
                                                            <small style="color: #64748b; font-weight: 600;">Ingredients:</small><br>
                                                            ${item.customizations.map(custom => `
                                                                <small style="color: #475569;">
                                                                    ‚Ä¢ ${custom.ingredient_name || custom.name} (${custom.quantity} ${custom.unit || 'unit'}) - ‚Çπ${(custom.price * custom.quantity).toFixed(2)}
                                                                </small><br>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </td>
                                                <td>${item.quantity}</td>
                                                <td>‚Çπ${item.price.toFixed(2)}</td>
                                                <td>‚Çπ${(item.price * item.quantity).toFixed(2)}</td>
                                            </tr>
                                        `;
                                        return itemRow;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div>
                                <h3 style="margin-bottom: 12px; color: #1e293b;">üìç Shipping Address</h3>
                                <p><strong>Name:</strong> ${order.shipping_address.name}</p>
                                <p><strong>Street:</strong> ${order.shipping_address.street}</p>
                                <p><strong>City:</strong> ${order.shipping_address.city}, ${order.shipping_address.state}</p>
                                <p><strong>Zip:</strong> ${order.shipping_address.zip_code}</p>
                                <p><strong>Phone:</strong> ${order.shipping_address.phone}</p>
                            </div>
                            <div>
                                <h3 style="margin-bottom: 12px; color: #1e293b;">üí∞ Payment Summary</h3>
                                <p><strong>Subtotal:</strong> ‚Çπ${itemsTotal.toFixed(2)}</p>
                                <p><strong>Discount:</strong> -‚Çπ${order.discount_amount.toFixed(2)}</p>
                                ${order.coupon_code ? `<p><strong>Coupon:</strong> ${order.coupon_code}</p>` : ''}
                                <p style="font-size: 18px; font-weight: 700; color: #ffd700;"><strong>Final Total:</strong> ‚Çπ${order.final_price.toFixed(2)}</p>
                            </div>
                        </div>
                        
                        ${order.assigned_agent_id ? `
                            <div>
                                <h3 style="margin-bottom: 12px; color: #1e293b;">üöö Delivery Agent</h3>
                                <p><strong>Agent:</strong> ${order.agent_name || 'Assigned'}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                modal.classList.add('active');
            } catch (error) {
                console.error('Error loading order details:', error);
                showAlert('orders', 'Error loading order details', 'error');
            }
        }

        // Authentication check
        async function checkAuthentication() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = '/api/admin-login';
                return false;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    localStorage.removeItem('admin_token');
                    window.location.href = '/api/admin-login';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('admin_token');
                window.location.href = '/api/admin-login';
                return false;
            }
        }

        // Add auth header to all API requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const token = localStorage.getItem('admin_token');
            if (token && args[1]) {
                args[1].headers = {
                    ...args[1].headers,
                    'Authorization': `Bearer ${token}`
                };
            } else if (token && !args[1]) {
                args[1] = {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                };
            }
            return originalFetch.apply(this, args);
        };

        // Initialize event listeners when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, checking authentication');
            
            // Check authentication first
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // Don't proceed if not authenticated
            }
            
            console.log('Authenticated, setting up navigation');
            
            // Add click handlers to all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    console.log('Nav item clicked:', tabName);
                    
                    if (tabName === 'products-toggle') {
                        toggleProductsMenu();
                    } else if (tabName) {
                        switchTab(tabName);
                    }
                });
            });
            
            // Add click handlers to order status tabs
            document.querySelectorAll('.status-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const status = this.getAttribute('data-status');
                    if (status) {
                        filterOrdersByStatus(status);
                    }
                });
            });
            
            // Load initial dashboard
            console.log('Loading initial dashboard');
            loadDashboard();
        });

    </script>
</body>
</html>
