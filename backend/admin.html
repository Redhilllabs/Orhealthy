<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrHealthy Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 12px rgba(0,0,0,0.2); position: fixed; height: 100vh; left: 0; top: 0; }
        .logo-section { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; background: rgba(255,215,0,0.1); }
        .logo-section img { width: 48px; height: 48px; border-radius: 12px; }
        .logo-text h1 { font-size: 20px; font-weight: 700; color: #ffd700; }
        .logo-text p { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        .nav-menu { flex: 1; padding: 16px 0; overflow-y: auto; }
        .nav-item { padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s; color: rgba(255,255,255,0.7); border-left: 3px solid transparent; font-size: 14px; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: rgba(255,215,0,0.15); color: #ffd700; border-left-color: #ffd700; }
        .nav-icon { font-size: 18px; width: 20px; }
        
        /* Main Content */
        .main-content { flex: 1; margin-left: 260px; }
        .top-bar { background: white; padding: 20px 32px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 700; color: #1e293b; }
        .content-area { padding: 32px; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(255,215,0,0.2); }
        .stat-number { font-size: 40px; font-weight: 800; margin-bottom: 8px; }
        .stat-label { font-size: 13px; opacity: 0.8; font-weight: 600; }
        
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 20px; font-weight: 700; color: #1e293b; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, textarea, select { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #ffd700; box-shadow: 0 0 0 3px rgba(255,215,0,0.1); }
        textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        
        .btn { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #1e293b; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255,215,0,0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,215,0,0.4); }
        .btn-secondary { background: #64748b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .image-upload { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc; }
        .image-upload:hover { border-color: #ffd700; background: rgba(255,215,0,0.05); }
        .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 12px; }
        .image-preview-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-remove { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; font-weight: bold; }
        
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 14px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .table th { background: #f8fafc; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        .table tr:hover { background: #f8fafc; }
        .table-image { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
        
        .actions { display: flex; gap: 8px; }
        .actions button { padding: 6px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 32px; border-radius: 16px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f1f5f9; }
        .modal-title { font-size: 22px; font-weight: 700; color: #1e293b; }
        .close { font-size: 28px; cursor: pointer; color: #94a3b8; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s; }
        .close:hover { background: #f1f5f9; color: #475569; }
        
        .alert { padding: 14px 18px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        
        .ingredient-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .ingredient-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #f1f5f9; border-radius: 8px; font-size: 13px; }
        .ingredient-item input { width: 60px; padding: 4px 8px; font-size: 13px; }
        .ingredient-item button { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 4px 10px; cursor: pointer; font-weight: 600; }
        
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px; }
        .config-label { font-weight: 600; color: #475569; }
        .config-input { width: 120px; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-section">
            <img src="https://customer-assets.emergentagent.com/job_nutritionhub-1/artifacts/kq74ajf1_Orhealthy%20Favicon.png" alt="Logo">
            <div class="logo-text">
                <h1>OrHealthy</h1>
                <p>Admin Panel</p>
            </div>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('dashboard')">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchTab('ingredients')">
                <span class="nav-icon">ü•ó</span>
                <span>Ingredients</span>
            </div>
            <div class="nav-item" onclick="switchTab('meals')">
                <span class="nav-icon">üçΩÔ∏è</span>
                <span>Preset Meals</span>
            </div>
            <div class="nav-item" onclick="switchTab('users')">
                <span class="nav-icon">üë•</span>
                <span>Users</span>
            </div>
            <div class="nav-item" onclick="switchTab('orders')">
                <span class="nav-icon">üì¶</span>
                <span>Orders</span>
            </div>
            <div class="nav-item" onclick="switchTab('coupons')">
                <span class="nav-icon">üéüÔ∏è</span>
                <span>Coupons</span>
            </div>
            <div class="nav-item" onclick="switchTab('withdrawals')">
                <span class="nav-icon">üí∞</span>
                <span>Withdrawals</span>
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
        </div>
        
        <div class="content-area">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalIngredients">0</div>
                        <div class="stat-label">Ingredients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMeals">0</div>
                        <div class="stat-label">Preset Meals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                </div>
            </div>

            <!-- Ingredients -->
            <div id="ingredients" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Ingredients Management</h2>
                        <button class="btn" onclick="showIngredientModal()">+ Add Ingredient</button>
                    </div>
                    <div id="alert-ingredients"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Price/Unit</th>
                                <th>Unit</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Meals -->
            <div id="meals" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Preset Meals Management</h2>
                        <button class="btn" onclick="showMealModal()">+ Add Meal</button>
                    </div>
                    <div id="alert-meals"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mealsBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Users -->
            <div id="users" class="section">
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 20px;">Users Management</h2>
                    <div id="alert-users"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Points</th>
                                <th>Inherent</th>
                                <th>Stars</th>
                                <th>Is Guide</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Orders -->
            <div id="orders" class="section">
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 20px;">Orders Management</h2>
                    <div id="alert-orders"></div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Items</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings -->

            <!-- Coupons -->
            <div id="coupons" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Discount Coupons</h2>
                        <button class="btn" onclick="showAddCouponModal()">+ Add Coupon</button>
                    </div>
                    <div id="alert-coupons"></div>
                    <table class="table" id="couponsTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Min Order</th>
                                <th>Usage</th>
                                <th>Expiry</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="couponsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Withdrawals -->
            <div id="withdrawals" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Withdrawal Requests</h2>
                    </div>
                    <div id="alert-withdrawals"></div>
                    <table class="table" id="withdrawalsTable">
                        <thead>
                            <tr>
                                <th>Guide</th>
                                <th>Amount</th>
                                <th>Requested On</th>
                                <th>Status</th>
                                <th>Processed On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTableBody"></tbody>
                    </table>
                </div>
            </div>


            <div id="settings" class="section">
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 20px;">Star Rating Configuration</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Configure the points required for each star rating level. Users with 1+ stars become Guides.</p>
                    <div id="alert-settings"></div>
                    
                    <div id="starRatingsList"></div>
                    
                    <button class="btn btn-secondary" style="margin-top: 16px; margin-right: 12px;" onclick="addStarRating()">+ Add Rating Level</button>
                    <button class="btn" style="margin-top: 16px;" onclick="saveStarConfig()">Save Configuration</button>
                </div>


 


                <div class="card" style="margin-top: 24px;">
                    <h2 class="card-title" style="margin-bottom: 20px;">Points Configuration</h2>
                    <p style="color: #64748b; margin-bottom: 24px;">Configure points earned for different actions.</p>
                    <div id="alert-points"></div>
                    
                    <div style="display: grid; gap: 16px;">
                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">üìù Per Post</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerPost" value="5" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>

                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">‚ù§Ô∏è Per Like Received</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerLike" value="2" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>

                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">üë• Per New Fan</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerFan" value="3" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>

                        <div class="config-item">
                            <div style="min-width: 200px;">
                                <span class="config-label">üéì Per New Guidee</span>
                            </div>
                            <input type="number" class="config-input" id="pointsPerGuidee" value="5" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px;">points</span>
                        </div>
                    </div>
                    
                    <button class="btn" style="margin-top: 24px;" onclick="savePointsConfig()">Save Points Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="ingredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Ingredient</h2>
                <span class="close" onclick="closeModal('ingredientModal')">&times;</span>
            </div>
            <form id="ingredientForm" onsubmit="saveIngredient(event)">
                <div class="form-group">
                    <label>Images</label>
                    <div class="image-upload" onclick="document.getElementById('ingredientImages').click()">
                        <div style="font-size: 40px; margin-bottom: 8px;">üì∑</div>
                        <div style="font-weight: 600; color: #475569;">Click to upload images</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Multiple images supported</div>
                    </div>
                    <input type="file" id="ingredientImages" multiple accept="image/*" style="display: none;" onchange="handleIngredientImages(event)">
                    <div id="ingredientImagePreview" class="image-preview-grid"></div>
                </div>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="ingredientName" required>
                </div>
                <div class="form-group">
                    <label>Price per Unit (‚Çπ) *</label>
                    <input type="number" step="0.01" id="ingredientPrice" required>
                </div>
                <div class="form-group">
                    <label>Unit *</label>
                    <select id="ingredientUnit" required>
                        <option value="">Select unit</option>
                        <option value="cup">Cup</option>
                        <option value="piece">Piece</option>
                        <option value="oz">Ounce</option>
                        <option value="g">Grams</option>
                        <option value="ml">Milliliters</option>
                        <option value="bowl">Bowl</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="ingredientTags" placeholder="e.g. protein, vegetarian, organic">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="ingredientDescription"></textarea>
                </div>
                <button type="submit" class="btn">Save Ingredient</button>
            </form>
        </div>
    </div>

    <div id="mealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Preset Meal</h2>
                <span class="close" onclick="closeModal('mealModal')">&times;</span>
            </div>
            <form id="mealForm" onsubmit="saveMeal(event)">
                <div class="form-group">
                    <label>Images</label>
                    <div class="image-upload" onclick="document.getElementById('mealImages').click()">
                        <div style="font-size: 40px; margin-bottom: 8px;">üì∑</div>
                        <div style="font-weight: 600; color: #475569;">Click to upload images</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Multiple images supported</div>
                    </div>
                    <input type="file" id="mealImages" multiple accept="image/*" style="display: none;" onchange="handleMealImages(event)">
                    <div id="mealImagePreview" class="image-preview-grid"></div>
                </div>
                <div class="form-group">
                    <label>Meal Name *</label>
                    <input type="text" id="mealName" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="mealDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>Price (‚Çπ) *</label>
                    <input type="number" step="0.01" id="mealPrice" required>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="mealTags" placeholder="e.g. high-protein, low-carb, vegan">
                </div>
                <div class="form-group">
                    <label>Ingredients *</label>
                    <select id="mealIngredientSelect">
                        <option value="">-- Select ingredient --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="addIngredientToMeal()">Add Ingredient</button>
                    <div class="ingredient-list" id="mealIngredients"></div>
                </div>
                <button type="submit" class="btn">Save Meal</button>
            </form>
        </div>
    </div>

    <div id="userPointsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Update User Points</h2>
                <span class="close" onclick="closeModal('userPointsModal')">&times;</span>
            </div>
            <form id="userPointsForm" onsubmit="saveUserPoints(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>User Name</label>
                    <input type="text" id="userName" readonly>
                </div>
                <div class="form-group">
                    <label>Current Points</label>
                    <input type="number" id="currentPoints" readonly>
                </div>
                <div class="form-group">
                    <label>Inherent Points</label>
                    <input type="number" id="inherentPoints" value="0">
                </div>
                <button type="submit" class="btn">Update Points</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let selectedMealIngredients = [];
        let allIngredients = [];
        let ingredientImages = [];
        let mealImages = [];
        let editingIngredientId = null;
        let editingMealId = null;

        const pageTitles = {
            dashboard: 'Dashboard',
            ingredients: 'Ingredients Management',
            meals: 'Preset Meals Management',
            users: 'Users Management',
            orders: 'Orders Management',
            settings: 'Settings'
        };

        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            document.getElementById('pageTitle').textContent = pageTitles[tabName];

            switch(tabName) {
                case 'dashboard': loadDashboard(); break;
                case 'ingredients': loadIngredients(); break;
                case 'meals': loadMeals(); break;
                case 'users': loadUsers(); break;
                case 'orders': loadOrders(); break;
                case 'settings': loadSettings(); break;
            }
        }

        function handleIngredientImages(event) {
            const files = Array.from(event.target.files);
            ingredientImages = [];
            const preview = document.getElementById('ingredientImagePreview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    ingredientImages.push(e.target.result);
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeIngredientImage(${index})">√ó</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeIngredientImage(index) {
            ingredientImages.splice(index, 1);
            document.getElementById('ingredientImages').value = '';
            handleIngredientImages({ target: { files: [] } });
        }

        function handleMealImages(event) {
            const files = Array.from(event.target.files);
            mealImages = [];
            const preview = document.getElementById('mealImagePreview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mealImages.push(e.target.result);
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeMealImage(${index})">√ó</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeMealImage(index) {
            mealImages.splice(index, 1);
            document.getElementById('mealImages').value = '';
            handleMealImages({ target: { files: [] } });
        }

        async function loadDashboard() {
            try {
                const [users, ingredients, meals, orders] = await Promise.all([
                    fetch(`${API_URL}/admin/users`).then(r => r.json()),
                    fetch(`${API_URL}/ingredients`).then(r => r.json()),
                    fetch(`${API_URL}/meals`).then(r => r.json()),
                    fetch(`${API_URL}/admin/orders`).then(r => r.json())
                ]);
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalIngredients').textContent = ingredients.length;
                document.getElementById('totalMeals').textContent = meals.length;
                document.getElementById('totalOrders').textContent = orders.length;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadIngredients() {
            try {
                const ingredients = await fetch(`${API_URL}/ingredients`).then(r => r.json());
                allIngredients = ingredients;
                const tbody = document.getElementById('ingredientsBody');
                tbody.innerHTML = ingredients.map(ing => `
                    <tr>
                        <td>${ing.images && ing.images.length > 0 ? `<img src="${ing.images[0]}" class="table-image">` : '-'}</td>
                        <td>${ing.name}</td>
                        <td>‚Çπ${ing.price_per_unit.toFixed(2)}</td>
                        <td>${ing.unit}</td>
                        <td>${ing.tags ? ing.tags.join(', ') : '-'}</td>
                        <td class="actions">
                            <button class="btn" onclick="editIngredient('${ing._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteIngredient('${ing._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
                updateMealIngredientSelect();
            } catch (error) {
                showAlert('ingredients', 'Error loading ingredients', 'error');
            }
        }

        function showIngredientModal() {
            editingIngredientId = null;
            document.getElementById('ingredientModal').classList.add('active');
            document.querySelector('#ingredientModal .modal-title').textContent = 'Add Ingredient';
            document.getElementById('ingredientForm').reset();
            ingredientImages = [];
            document.getElementById('ingredientImagePreview').innerHTML = '';
        }

        function editIngredient(id) {
            editingIngredientId = id;
            const ingredient = allIngredients.find(i => i._id === id);
            if (!ingredient) return;
            
            document.getElementById('ingredientModal').classList.add('active');
            document.querySelector('#ingredientModal .modal-title').textContent = 'Edit Ingredient';
            document.getElementById('ingredientName').value = ingredient.name;
            document.getElementById('ingredientPrice').value = ingredient.price_per_unit;
            document.getElementById('ingredientUnit').value = ingredient.unit;
            document.getElementById('ingredientDescription').value = ingredient.description || '';
            document.getElementById('ingredientTags').value = ingredient.tags ? ingredient.tags.join(', ') : '';
            
            // Set existing images
            ingredientImages = ingredient.images || [];
            const preview = document.getElementById('ingredientImagePreview');
            preview.innerHTML = ingredientImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview">
                    <button type="button" class="image-remove" onclick="removeIngredientImage(${index})">√ó</button>
                </div>
            `).join('');
        }

        async function saveIngredient(e) {
            e.preventDefault();
            const tags = document.getElementById('ingredientTags').value
                .split(',').map(t => t.trim()).filter(Boolean);
            
            const data = {
                name: document.getElementById('ingredientName').value,
                price_per_unit: parseFloat(document.getElementById('ingredientPrice').value),
                unit: document.getElementById('ingredientUnit').value,
                description: document.getElementById('ingredientDescription').value,
                tags: tags,
                images: ingredientImages
            };
            
            try {
                let response;
                if (editingIngredientId) {
                    // Update existing ingredient
                    response = await fetch(`${API_URL}/admin/ingredients/${editingIngredientId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new ingredient
                    response = await fetch(`${API_URL}/admin/ingredients`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeModal('ingredientModal');
                    showAlert('ingredients', editingIngredientId ? 'Ingredient updated successfully' : 'Ingredient saved successfully', 'success');
                    loadIngredients();
                }
            } catch (error) {
                showAlert('ingredients', 'Error saving ingredient', 'error');
            }
        }

        async function deleteIngredient(id) {
            if (!confirm('Delete this ingredient?')) return;
            try {
                await fetch(`${API_URL}/admin/ingredients/${id}`, { method: 'DELETE' });
                showAlert('ingredients', 'Deleted successfully', 'success');
                loadIngredients();
            } catch (error) {
                showAlert('ingredients', 'Error deleting', 'error');
            }
        }

        async function loadMeals() {
            try {
                const meals = await fetch(`${API_URL}/meals`).then(r => r.json());
                const tbody = document.getElementById('mealsBody');
                tbody.innerHTML = meals.map(meal => `
                    <tr>
                        <td>${meal.images && meal.images.length > 0 ? `<img src="${meal.images[0]}" class="table-image">` : '-'}</td>
                        <td>${meal.name}</td>
                        <td>${meal.description}</td>
                        <td>‚Çπ${meal.base_price.toFixed(2)}</td>
                        <td>${meal.tags ? meal.tags.join(', ') : '-'}</td>
                        <td class="actions">
                            <button class="btn" onclick="editMeal('${meal._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMeal('${meal._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('meals', 'Error loading meals', 'error');
            }
        }

        function showMealModal() {
            editingMealId = null;
            document.getElementById('mealModal').classList.add('active');
            document.querySelector('#mealModal .modal-title').textContent = 'Add Preset Meal';
            document.getElementById('mealForm').reset();
            selectedMealIngredients = [];
            mealImages = [];
            document.getElementById('mealIngredients').innerHTML = '';
            document.getElementById('mealImagePreview').innerHTML = '';
        }

        async function editMeal(id) {
            editingMealId = id;
            try {
                const response = await fetch(`${API_URL}/meals/${id}`);
                const meal = await response.json();
                
                document.getElementById('mealModal').classList.add('active');
                document.querySelector('#mealModal .modal-title').textContent = 'Edit Preset Meal';
                document.getElementById('mealName').value = meal.name;
                document.getElementById('mealDescription').value = meal.description;
                document.getElementById('mealPrice').value = meal.base_price;
                document.getElementById('mealTags').value = meal.tags ? meal.tags.join(', ') : '';
                
                // Set existing images
                mealImages = meal.images || [];
                const preview = document.getElementById('mealImagePreview');
                preview.innerHTML = mealImages.map((img, index) => `
                    <div class="image-preview-item">
                        <img src="${img}" alt="Preview">
                        <button type="button" class="image-remove" onclick="removeMealImage(${index})">√ó</button>
                    </div>
                `).join('');
                
                // Set existing ingredients
                selectedMealIngredients = meal.ingredients || [];
                renderMealIngredients();
            } catch (error) {
                showAlert('meals', 'Error loading meal data', 'error');
            }
        }

        function updateMealIngredientSelect() {
            const select = document.getElementById('mealIngredientSelect');
            select.innerHTML = '<option value="">-- Select ingredient --</option>' +
                allIngredients.map(ing => `<option value="${ing._id}">${ing.name} (‚Çπ${ing.price_per_unit}/${ing.unit})</option>`).join('');
        }

        function addIngredientToMeal() {
            const select = document.getElementById('mealIngredientSelect');
            const ingredientId = select.value;
            if (!ingredientId) return alert('Please select an ingredient');
            const ingredient = allIngredients.find(i => i._id === ingredientId);
            if (!ingredient) return;
            if (selectedMealIngredients.find(i => i.ingredient_id === ingredientId)) {
                return alert('Ingredient already added');
            }
            selectedMealIngredients.push({
                ingredient_id: ingredientId,
                name: ingredient.name,
                price: ingredient.price_per_unit,
                default_quantity: 1
            });
            renderMealIngredients();
        }

        function renderMealIngredients() {
            document.getElementById('mealIngredients').innerHTML = selectedMealIngredients.map((ing, idx) => `
                <div class="ingredient-item">
                    <span>${ing.name}</span>
                    <input type="number" min="0.1" step="0.1" value="${ing.default_quantity}" 
                           onchange="updateIngredientQuantity(${idx}, this.value)">
                    <button type="button" onclick="removeIngredientFromMeal(${idx})">√ó</button>
                </div>
            `).join('');
        }

        function updateIngredientQuantity(index, quantity) {
            selectedMealIngredients[index].default_quantity = parseFloat(quantity);
        }

        function removeIngredientFromMeal(index) {
            selectedMealIngredients.splice(index, 1);
            renderMealIngredients();
        }

        async function saveMeal(e) {
            e.preventDefault();
            if (selectedMealIngredients.length === 0) return alert('Add at least one ingredient');
            
            const tags = document.getElementById('mealTags').value
                .split(',').map(t => t.trim()).filter(Boolean);
            
            const data = {
                name: document.getElementById('mealName').value,
                description: document.getElementById('mealDescription').value,
                base_price: parseFloat(document.getElementById('mealPrice').value),
                ingredients: selectedMealIngredients,
                tags: tags,
                images: mealImages,
                is_preset: true,
                created_by: 'admin'
            };
            
            try {
                let response;
                if (editingMealId) {
                    // Update existing meal
                    response = await fetch(`${API_URL}/admin/meals/${editingMealId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new meal
                    response = await fetch(`${API_URL}/admin/meals`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }
                
                if (response.ok) {
                    closeModal('mealModal');
                    showAlert('meals', editingMealId ? 'Meal updated successfully' : 'Meal saved successfully', 'success');
                    loadMeals();
                }
            } catch (error) {
                showAlert('meals', 'Error saving meal', 'error');
            }
        }

        async function deleteMeal(id) {
            if (!confirm('Delete this meal?')) return;
            try {
                await fetch(`${API_URL}/admin/meals/${id}`, { method: 'DELETE' });
                showAlert('meals', 'Deleted successfully', 'success');
                loadMeals();
            } catch (error) {
                showAlert('meals', 'Error deleting', 'error');
            }
        }

        async function loadUsers() {
            try {
                const users = await fetch(`${API_URL}/admin/users`).then(r => r.json());
                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.points}</td>
                        <td>${user.inherent_points}</td>
                        <td>${user.star_rating} ‚≠ê</td>
                        <td>${user.is_guide ? 'Yes' : 'No'}</td>
                        <td class="actions">
                            <button class="btn" onclick="showUserPointsModal('${user._id}', '${user.name}', ${user.points}, ${user.inherent_points})">
                                Update
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('users', 'Error loading users', 'error');
            }
        }

        function showUserPointsModal(id, name, points, inherentPoints) {
            document.getElementById('userPointsModal').classList.add('active');
            document.getElementById('userId').value = id;
            document.getElementById('userName').value = name;
            document.getElementById('currentPoints').value = points;
            document.getElementById('inherentPoints').value = inherentPoints;
        }

        async function saveUserPoints(e) {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const inherentPoints = parseInt(document.getElementById('inherentPoints').value);
            try {
                const response = await fetch(`${API_URL}/admin/users/${userId}/points`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ inherent_points: inherentPoints })
                });
                if (response.ok) {
                    closeModal('userPointsModal');
                    showAlert('users', 'Points updated successfully', 'success');
                    loadUsers();
                }
            } catch (error) {
                showAlert('users', 'Error updating points', 'error');
            }
        }

        async function loadOrders() {
            try {
                const orders = await fetch(`${API_URL}/admin/orders`).then(r => r.json());
                const tbody = document.getElementById('ordersBody');
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>${order._id.substring(0, 8)}...</td>
                        <td>‚Çπ${order.total_price.toFixed(2)}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order._id}', this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>${order.items.length}</td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('orders', 'Error loading orders', 'error');
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                await fetch(`${API_URL}/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status })
                });
                showAlert('orders', 'Order status updated', 'success');
            } catch (error) {
                showAlert('orders', 'Error updating order', 'error');
            }
        }

        let starRatings = {};
        let commissionRates = {};

        function renderStarRatings() {
            const container = document.getElementById('starRatingsList');
            const sortedKeys = Object.keys(starRatings).sort((a, b) => {
                const numA = parseInt(a.replace('star', ''));
                const numB = parseInt(b.replace('star', ''));
                return numA - numB;
            });
            
            container.innerHTML = sortedKeys.map((key, index) => {
                const starNum = parseInt(key.replace('star', ''));
                const isFirst = index === 0;
                const commissionValue = commissionRates[key] || 0;
                return `
                    <div class="config-item">
                        <div style="min-width: 150px;">
                            <span class="config-label">${starNum}‚≠ê</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" class="config-input" id="${key}" value="${starRatings[key]}" min="0" style="width: 150px;">
                            <span style="color: #64748b; font-size: 13px; min-width: 180px;">${isFirst ? 'points (Becomes Guide)' : 'points'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" class="config-input" id="commission_${key}" value="${commissionValue}" min="0" max="100" step="0.5" style="width: 120px;">
                            <span style="color: #64748b; font-size: 13px; min-width: 140px;">% commission</span>
                        </div>
                        ${!isFirst ? `<button class="btn-danger" style="padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px;" onclick="removeStarRating('${key}')">Remove</button>` : '<div style="width: 90px;"></div>'}
                    </div>
                `;
            }).join('');
        }

        function addStarRating() {
            const maxStar = Math.max(...Object.keys(starRatings).map(k => parseInt(k.replace('star', ''))));
            const newStarNum = maxStar + 1;
            const prevPoints = starRatings[`star${maxStar}`] || 0;
            const prevCommission = commissionRates[`star${maxStar}`] || 0;
            starRatings[`star${newStarNum}`] = Math.ceil(prevPoints * 1.5);
            commissionRates[`star${newStarNum}`] = Math.min(prevCommission + 3, 100);
            renderStarRatings();
        }

        function removeStarRating(key) {
            if (Object.keys(starRatings).length <= 1) {
                return alert('You must have at least one star rating level');
            }
            delete starRatings[key];
            delete commissionRates[key];
            renderStarRatings();
        }

        function loadSettings() {
            // Load star rating configuration from backend
            fetch(`${API_URL}/admin/star-config`)
                .then(r => r.json())
                .then(config => {
                    starRatings = config;
                    renderStarRatings();
                })
                .catch(error => {
                    console.error('Error loading star config:', error);
                    // Default configuration
                    starRatings = {
                        star1: 25,
                        star2: 100,
                        star3: 250,
                        star4: 500,
                        star5: 1000
                    };
                    renderStarRatings();
                });
            
            // Load commission rates configuration
            fetch(`${API_URL}/admin/commission-rates`)
                .then(r => r.json())
                .then(config => {
                    commissionRates = config;
                    renderStarRatings();
                })
                .catch(error => {
                    console.error('Error loading commission rates:', error);
                    // Default commission rates
                    commissionRates = {
                        star1: 3,
                        star2: 6,
                        star3: 9,
                        star4: 12,
                        star5: 15
                    };
                    renderStarRatings();
                });
            
            // Load points configuration
            loadPointsConfig();
        }

        async function saveStarConfig() {
            // Update star rating values from inputs
            Object.keys(starRatings).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    starRatings[key] = parseInt(input.value);
                }
            });
            
            // Update commission rate values from inputs
            Object.keys(starRatings).forEach(key => {
                const commissionInput = document.getElementById(`commission_${key}`);
                if (commissionInput) {
                    commissionRates[key] = parseFloat(commissionInput.value);
                }
            });
            
            try {
                // Save star ratings
                const starResponse = await fetch(`${API_URL}/admin/star-config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(starRatings)
                });
                
                // Save commission rates
                const commissionResponse = await fetch(`${API_URL}/admin/commission-rates`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(commissionRates)
                });
                
                if (starResponse.ok && commissionResponse.ok) {
                    showAlert('settings', 'Configuration saved successfully!', 'success');
                } else {
                    showAlert('settings', 'Error saving configuration', 'error');
                }
            } catch (error) {
                showAlert('settings', 'Error saving configuration', 'error');
                console.error('Error saving star config:', error);
            }
        }

        function loadPointsConfig() {
            fetch(`${API_URL}/admin/points-config`)
                .then(r => r.json())
                .then(config => {
                    document.getElementById('pointsPerPost').value = config.post || 5;
                    document.getElementById('pointsPerLike').value = config.like || 2;
                    document.getElementById('pointsPerFan').value = config.fan || 3;
                    document.getElementById('pointsPerGuidee').value = config.guidee || 5;
                })
                .catch(error => {
                    console.error('Error loading points config:', error);
                });
        }

        async function savePointsConfig() {
            const config = {
                post: parseInt(document.getElementById('pointsPerPost').value),
                like: parseInt(document.getElementById('pointsPerLike').value),
                fan: parseInt(document.getElementById('pointsPerFan').value),
                guidee: parseInt(document.getElementById('pointsPerGuidee').value)
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/points-config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showAlert('points', 'Points configuration saved successfully!', 'success');
                } else {
                    showAlert('points', 'Error saving points configuration', 'error');
                }
            } catch (error) {
                showAlert('points', 'Error saving points configuration', 'error');
                console.error('Error saving points config:', error);
            }
        }


        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(section, message, type) {
            const alertDiv = document.getElementById(`alert-${section}`);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 3000);
        }

        // Initialize
        loadDashboard();
        loadIngredients();
    </script>
</body>
</html>
