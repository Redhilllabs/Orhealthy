<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrHealthy Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }

        .logo-section {
            padding: 32px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(255,215,0,0.1);
        }

        .logo-section img {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(255,215,0,0.3);
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            color: #ffd700;
        }

        .logo-text p {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        .nav-menu {
            flex: 1;
            padding: 24px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 16px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s;
            color: rgba(255,255,255,0.7);
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            border-left-color: #ffd700;
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: #f8fafc;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background: white;
            padding: 24px 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }

        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(255,215,0,0.1), transparent);
            border-radius: 0 0 0 100%;
        }

        .stat-number {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1e293b;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255,215,0,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,215,0,0.4);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
            box-shadow: 0 4px 12px rgba(100,116,139,0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
        }

        /* Form Elements */
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 4px rgba(255,215,0,0.1);
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #334155;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Image Upload */
        .image-upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .image-upload-area:hover {
            border-color: #ffd700;
            background: rgba(255,215,0,0.05);
        }

        .image-upload-area.dragover {
            border-color: #ffd700;
            background: rgba(255,215,0,0.1);
        }

        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .image-preview {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239,68,68,0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .image-preview .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
        }

        .table th {
            padding: 18px;
            text-align: left;
            font-weight: 700;
            color: #1e293b;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .table td {
            padding: 16px 18px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tr:hover {
            background: #f8fafc;
        }

        .table-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .modal-title {
            font-size: 26px;
            font-weight: 700;
            color: #1e293b;
        }

        .close {
            font-size: 32px;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close:hover {
            background: #f1f5f9;
            color: #475569;
        }

        /* Alert */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .alert-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        /* Ingredient List in Meal Form */
        .ingredient-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            font-size: 14px;
            border: 2px solid #e2e8f0;
        }

        .ingredient-item input {
            width: 70px;
            padding: 6px 10px;
            font-size: 14px;
        }

        .ingredient-item button {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .ingredient-item button:hover {
            background: #dc2626;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ffd700, #ffed4e);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffd700;
        }
    </style>
</head>
<body>

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #4CAF50;
            color: white;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header img {
            width: 48px;
            height: 48px;
            border-radius: 24px;
        }

        .header h1 {
            font-size: 28px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            border-bottom-color: #4CAF50;
            background: white;
            color: #4CAF50;
        }

        .content {
            padding: 24px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-danger {
            background: #F44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .ingredient-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 14px;
        }

        .ingredient-item input {
            width: 60px;
            padding: 4px 8px;
        }

        .ingredient-item button {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f9f9f9;
            font-weight: 600;
        }

        .table tr:hover {
            background: #f9f9f9;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #333;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://customer-assets.emergentagent.com/job_nutritionhub-1/artifacts/kq74ajf1_Orhealthy%20Favicon.png" alt="OrHealthy Logo">
            <div>
                <h1>OrHealthy Admin Panel</h1>
                <p>Manage your nutrition ecosystem</p>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('ingredients')">Ingredients</div>
            <div class="tab" onclick="switchTab('meals')">Preset Meals</div>
            <div class="tab" onclick="switchTab('users')">Users</div>
            <div class="tab" onclick="switchTab('orders')">Orders</div>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div class="stats" id="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalIngredients">0</div>
                        <div class="stat-label">Ingredients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMeals">0</div>
                        <div class="stat-label">Preset Meals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                </div>
            </div>

            <!-- Ingredients -->
            <div id="ingredients" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Ingredients Management</h2>
                    <button class="btn" onclick="showIngredientModal()">+ Add Ingredient</button>
                </div>
                <div id="alert-ingredients"></div>
                <table class="table" id="ingredientsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price/Unit</th>
                            <th>Unit</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ingredientsBody"></tbody>
                </table>
            </div>

            <!-- Meals -->
            <div id="meals" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Preset Meals Management</h2>
                    <button class="btn" onclick="showMealModal()">+ Add Meal</button>
                </div>
                <div id="alert-meals"></div>
                <table class="table" id="mealsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Base Price</th>
                            <th>Ingredients</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mealsBody"></tbody>
                </table>
            </div>

            <!-- Users -->
            <div id="users" class="section">
                <h2>Users Management</h2>
                <div id="alert-users"></div>
                <table class="table" id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Points</th>
                            <th>Inherent Points</th>
                            <th>Star Rating</th>
                            <th>Is Guide</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody"></tbody>
                </table>
            </div>

            <!-- Orders -->
            <div id="orders" class="section">
                <h2>Orders Management</h2>
                <div id="alert-orders"></div>
                <table class="table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Total Price</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ingredient Modal -->
    <div id="ingredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="ingredientModalTitle">Add Ingredient</h2>
                <span class="close" onclick="closeModal('ingredientModal')">&times;</span>
            </div>
            <form id="ingredientForm" onsubmit="saveIngredient(event)">
                <input type="hidden" id="ingredientId">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="ingredientName" required>
                </div>
                <div class="form-group">
                    <label>Price per Unit *</label>
                    <input type="number" step="0.01" id="ingredientPrice" required>
                </div>
                <div class="form-group">
                    <label>Unit *</label>
                    <select id="ingredientUnit" required>
                        <option value="">Select unit</option>
                        <option value="cup">Cup</option>
                        <option value="piece">Piece</option>
                        <option value="oz">Ounce</option>
                        <option value="g">Grams</option>
                        <option value="ml">Milliliters</option>
                        <option value="bowl">Bowl</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="ingredientDescription"></textarea>
                </div>
                <button type="submit" class="btn">Save Ingredient</button>
            </form>
        </div>
    </div>

    <!-- Meal Modal -->
    <div id="mealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mealModalTitle">Add Preset Meal</h2>
                <span class="close" onclick="closeModal('mealModal')">&times;</span>
            </div>
            <form id="mealForm" onsubmit="saveMeal(event)">
                <input type="hidden" id="mealId">
                <div class="form-group">
                    <label>Meal Name *</label>
                    <input type="text" id="mealName" required>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="mealDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>Base Price *</label>
                    <input type="number" step="0.01" id="mealPrice" required>
                </div>
                <div class="form-group">
                    <label>Select Ingredients *</label>
                    <select id="mealIngredientSelect">
                        <option value="">-- Select an ingredient --</option>
                    </select>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="addIngredientToMeal()">Add Ingredient</button>
                    <div class="ingredient-list" id="mealIngredients"></div>
                </div>
                <button type="submit" class="btn">Save Meal</button>
            </form>
        </div>
    </div>

    <!-- User Points Modal -->
    <div id="userPointsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update User Points</h2>
                <span class="close" onclick="closeModal('userPointsModal')">&times;</span>
            </div>
            <form id="userPointsForm" onsubmit="saveUserPoints(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>User Name</label>
                    <input type="text" id="userName" readonly>
                </div>
                <div class="form-group">
                    <label>Current Points</label>
                    <input type="number" id="currentPoints" readonly>
                </div>
                <div class="form-group">
                    <label>Inherent Points</label>
                    <input type="number" id="inherentPoints" value="0">
                </div>
                <button type="submit" class="btn">Update Points</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let selectedMealIngredients = [];
        let allIngredients = [];

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Load data when switching tabs
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'ingredients':
                    loadIngredients();
                    break;
                case 'meals':
                    loadMeals();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'orders':
                    loadOrders();
                    break;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const [users, ingredients, meals, orders] = await Promise.all([
                    fetch(`${API_URL}/admin/users`).then(r => r.json()),
                    fetch(`${API_URL}/ingredients`).then(r => r.json()),
                    fetch(`${API_URL}/meals`).then(r => r.json()),
                    fetch(`${API_URL}/admin/orders`).then(r => r.json())
                ]);

                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalIngredients').textContent = ingredients.length;
                document.getElementById('totalMeals').textContent = meals.length;
                document.getElementById('totalOrders').textContent = orders.length;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Ingredients
        async function loadIngredients() {
            try {
                const ingredients = await fetch(`${API_URL}/ingredients`).then(r => r.json());
                allIngredients = ingredients;
                
                const tbody = document.getElementById('ingredientsBody');
                tbody.innerHTML = ingredients.map(ing => `
                    <tr>
                        <td>${ing.name}</td>
                        <td>$${ing.price_per_unit.toFixed(2)}</td>
                        <td>${ing.unit}</td>
                        <td>${ing.description || '-'}</td>
                        <td class="actions">
                            <button class="btn btn-danger" onclick="deleteIngredient('${ing._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');

                // Update meal ingredient select
                updateMealIngredientSelect();
            } catch (error) {
                showAlert('ingredients', 'Error loading ingredients', 'error');
            }
        }

        function showIngredientModal() {
            document.getElementById('ingredientModal').classList.add('active');
            document.getElementById('ingredientForm').reset();
            document.getElementById('ingredientId').value = '';
            document.getElementById('ingredientModalTitle').textContent = 'Add Ingredient';
        }

        async function saveIngredient(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('ingredientName').value,
                price_per_unit: parseFloat(document.getElementById('ingredientPrice').value),
                unit: document.getElementById('ingredientUnit').value,
                description: document.getElementById('ingredientDescription').value
            };

            try {
                const response = await fetch(`${API_URL}/admin/ingredients`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal('ingredientModal');
                    showAlert('ingredients', 'Ingredient saved successfully', 'success');
                    loadIngredients();
                } else {
                    throw new Error('Failed to save ingredient');
                }
            } catch (error) {
                showAlert('ingredients', 'Error saving ingredient', 'error');
            }
        }

        async function deleteIngredient(id) {
            if (!confirm('Are you sure you want to delete this ingredient?')) return;
            
            try {
                const response = await fetch(`${API_URL}/admin/ingredients/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('ingredients', 'Ingredient deleted successfully', 'success');
                    loadIngredients();
                } else {
                    throw new Error('Failed to delete ingredient');
                }
            } catch (error) {
                showAlert('ingredients', 'Error deleting ingredient', 'error');
            }
        }

        // Meals
        async function loadMeals() {
            try {
                const meals = await fetch(`${API_URL}/meals`).then(r => r.json());
                
                const tbody = document.getElementById('mealsBody');
                tbody.innerHTML = meals.map(meal => `
                    <tr>
                        <td>${meal.name}</td>
                        <td>${meal.description}</td>
                        <td>$${meal.base_price.toFixed(2)}</td>
                        <td>${meal.ingredients.length} ingredients</td>
                        <td class="actions">
                            <button class="btn btn-danger" onclick="deleteMeal('${meal._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('meals', 'Error loading meals', 'error');
            }
        }

        function showMealModal() {
            document.getElementById('mealModal').classList.add('active');
            document.getElementById('mealForm').reset();
            document.getElementById('mealId').value = '';
            document.getElementById('mealModalTitle').textContent = 'Add Preset Meal';
            selectedMealIngredients = [];
            document.getElementById('mealIngredients').innerHTML = '';
        }

        function updateMealIngredientSelect() {
            const select = document.getElementById('mealIngredientSelect');
            select.innerHTML = '<option value="">-- Select an ingredient --</option>' +
                allIngredients.map(ing => 
                    `<option value="${ing._id}">${ing.name} ($${ing.price_per_unit}/${ing.unit})</option>`
                ).join('');
        }

        function addIngredientToMeal() {
            const select = document.getElementById('mealIngredientSelect');
            const ingredientId = select.value;
            
            if (!ingredientId) {
                alert('Please select an ingredient');
                return;
            }

            const ingredient = allIngredients.find(i => i._id === ingredientId);
            if (!ingredient) return;

            // Check if already added
            if (selectedMealIngredients.find(i => i.ingredient_id === ingredientId)) {
                alert('Ingredient already added');
                return;
            }

            selectedMealIngredients.push({
                ingredient_id: ingredientId,
                name: ingredient.name,
                price: ingredient.price_per_unit,
                default_quantity: 1
            });

            renderMealIngredients();
        }

        function renderMealIngredients() {
            const container = document.getElementById('mealIngredients');
            container.innerHTML = selectedMealIngredients.map((ing, index) => `
                <div class="ingredient-item">
                    <span>${ing.name}</span>
                    <input type="number" min="0.1" step="0.1" value="${ing.default_quantity}" 
                           onchange="updateIngredientQuantity(${index}, this.value)">
                    <button type="button" onclick="removeIngredientFromMeal(${index})">×</button>
                </div>
            `).join('');
        }

        function updateIngredientQuantity(index, quantity) {
            selectedMealIngredients[index].default_quantity = parseFloat(quantity);
        }

        function removeIngredientFromMeal(index) {
            selectedMealIngredients.splice(index, 1);
            renderMealIngredients();
        }

        async function saveMeal(e) {
            e.preventDefault();
            
            if (selectedMealIngredients.length === 0) {
                alert('Please add at least one ingredient');
                return;
            }

            const data = {
                name: document.getElementById('mealName').value,
                description: document.getElementById('mealDescription').value,
                base_price: parseFloat(document.getElementById('mealPrice').value),
                ingredients: selectedMealIngredients,
                is_preset: true,
                created_by: 'admin'
            };

            try {
                const response = await fetch(`${API_URL}/admin/meals`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal('mealModal');
                    showAlert('meals', 'Meal saved successfully', 'success');
                    loadMeals();
                } else {
                    throw new Error('Failed to save meal');
                }
            } catch (error) {
                showAlert('meals', 'Error saving meal', 'error');
            }
        }

        async function deleteMeal(id) {
            if (!confirm('Are you sure you want to delete this meal?')) return;
            
            try {
                const response = await fetch(`${API_URL}/admin/meals/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('meals', 'Meal deleted successfully', 'success');
                    loadMeals();
                } else {
                    throw new Error('Failed to delete meal');
                }
            } catch (error) {
                showAlert('meals', 'Error deleting meal', 'error');
            }
        }

        // Users
        async function loadUsers() {
            try {
                const users = await fetch(`${API_URL}/admin/users`).then(r => r.json());
                
                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.points}</td>
                        <td>${user.inherent_points}</td>
                        <td>${user.star_rating} ⭐</td>
                        <td>${user.is_guide ? 'Yes' : 'No'}</td>
                        <td class="actions">
                            <button class="btn" onclick="showUserPointsModal('${user._id}', '${user.name}', ${user.points}, ${user.inherent_points})">
                                Update Points
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('users', 'Error loading users', 'error');
            }
        }

        function showUserPointsModal(id, name, points, inherentPoints) {
            document.getElementById('userPointsModal').classList.add('active');
            document.getElementById('userId').value = id;
            document.getElementById('userName').value = name;
            document.getElementById('currentPoints').value = points;
            document.getElementById('inherentPoints').value = inherentPoints;
        }

        async function saveUserPoints(e) {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const inherentPoints = parseInt(document.getElementById('inherentPoints').value);

            try {
                const response = await fetch(`${API_URL}/admin/users/${userId}/points`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ inherent_points: inherentPoints })
                });

                if (response.ok) {
                    closeModal('userPointsModal');
                    showAlert('users', 'User points updated successfully', 'success');
                    loadUsers();
                } else {
                    throw new Error('Failed to update points');
                }
            } catch (error) {
                showAlert('users', 'Error updating user points', 'error');
            }
        }

        // Orders
        async function loadOrders() {
            try {
                const orders = await fetch(`${API_URL}/admin/orders`).then(r => r.json());
                
                const tbody = document.getElementById('ordersBody');
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>${order._id.substring(0, 8)}...</td>
                        <td>$${order.total_price.toFixed(2)}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order._id}', this.value)">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>${order.items.length} items</td>
                    </tr>
                `).join('');
            } catch (error) {
                showAlert('orders', 'Error loading orders', 'error');
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`${API_URL}/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    showAlert('orders', 'Order status updated successfully', 'success');
                } else {
                    throw new Error('Failed to update order');
                }
            } catch (error) {
                showAlert('orders', 'Error updating order status', 'error');
            }
        }

        // Utility functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(section, message, type) {
            const alertDiv = document.getElementById(`alert-${section}`);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertDiv.innerHTML = '', 3000);
        }

        // Initialize
        loadDashboard();
        loadIngredients();
    </script>
